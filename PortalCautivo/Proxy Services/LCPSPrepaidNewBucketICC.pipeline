<?xml version="1.0" encoding="UTF-8"?>
<con:pipelineEntry xmlns:con="http://www.bea.com/wli/sb/pipeline/config" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:oper="http://xmlns.oracle.com/servicebus/pipeline/operations">
    <con:coreEntry>
        <con:binding type="SOAP" isSoap12="false" xsi:type="con:SoapBindingType">
            <con5:wsdl ref="PortalCautivo/Resources/WSDLs/TraficTypePortal" xmlns:ser="http://www.bea.com/wli/sb/services" xmlns:con1="http://www.bea.com/wli/sb/stages/config" xmlns:con="http://www.bea.com/wli/sb/services/bindings/config" xmlns:http="http://www.bea.com/wli/sb/transports/http" xmlns:env="http://www.bea.com/wli/config/env" xmlns:con4="http://www.bea.com/wli/sb/stages/publish/config" xmlns:tran="http://www.bea.com/wli/sb/transports" xmlns:con2="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con5="http://www.bea.com/wli/sb/pipeline/config"/>
            <con:binding>
                <con:name>CaptivePortalPortBinding</con:name>
                <con:namespace>http://captive.portal.ws.ncl.nii.com</con:namespace>
            </con:binding>
        </con:binding>
        <oper:operations>
            <oper:monitoring enabled="false" aggregationInterval="10" level="pipeline"/>
            <oper:tracingEnabled>false</oper:tracingEnabled>
            <oper:reporting>true</oper:reporting>
            <oper:logging enabled="true" level="error"/>
            <oper:sla-alerting enabled="true" level="normal"/>
            <oper:pipeline-alerting enabled="true" level="normal"/>
        </oper:operations>
    </con:coreEntry>
    <con:router xmlns:ser="http://www.bea.com/wli/sb/services" xmlns:tran="http://www.bea.com/wli/sb/transports" xmlns:env="http://www.bea.com/wli/config/env" xmlns:http="http://www.bea.com/wli/sb/transports/http" xmlns:con1="http://www.bea.com/wli/sb/stages/config" xmlns:con2="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con4="http://www.bea.com/wli/sb/stages/publish/config">
        <con:pipeline type="request" name="PipelinePrepaidNewBucket_request" errorHandler="_onErrorHandler-7538415494247415963-6ca2b1e9.14e26b1c10e.-7249">
            <con:stage name="validaEntrada">
                <con:context>
                    <con1:varNsDecl namespace="http://captive.portal.ws.ncl.nii.com" prefix="cap"/>
                </con:context>
                <con:actions>
                    <con2:assign varName="familyPlan">
                        <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-6b9f</con1:id>
                        <con2:expr>
                            <con1:xqueryText>data($body/cap:setNextelActiveProduct/family_plan)</con1:xqueryText>
                        </con2:expr>
                    </con2:assign>
                    <con2:assign varName="planEntrada">
                        <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-6b9e</con1:id>
                        <con2:expr>
                            <con1:xqueryText>data($body/cap:setNextelActiveProduct/codPlan)</con1:xqueryText>
                        </con2:expr>
                    </con2:assign>
                    <con2:ifThenElse>
                        <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-6b9d</con1:id>
                        <con2:case>
                            <con2:condition>
                                <con1:xqueryConditionExpr>
                                    <con1:boolExpr operator="and">
                                        <con1:compExpr operator="=">
                                            <con1:leftPath>upper-case(data($body/cap:setNextelActiveProduct/platform_act))</con1:leftPath>
                                            <con1:rightPath>'ICC'</con1:rightPath>
                                        </con1:compExpr>
                                        <con1:compExpr operator="=">
                                            <con1:leftPath>upper-case(data($body/cap:setNextelActiveProduct/segment_prod))</con1:leftPath>
                                            <con1:rightPath>('PREPAID','HYBRID')</con1:rightPath>
                                        </con1:compExpr>
                                    </con1:boolExpr>
                                </con1:xqueryConditionExpr>
                            </con2:condition>
                            <con2:actions>
                                <con2:assign varName="planOK">
                                    <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-6b9b</con1:id>
                                    <con2:expr>
                                        <con1:xqueryText>contains(xs:string($familyPlan),$planEntrada)</con1:xqueryText>
                                    </con2:expr>
                                </con2:assign>
                                <con2:ifThenElse>
                                    <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-6b9a</con1:id>
                                    <con2:case>
                                        <con2:condition>
                                            <con1:xqueryConditionExpr>
                                                <con1:compExpr operator="!=">
                                                    <con1:leftPath>xs:boolean($planOK)</con1:leftPath>
                                                    <con1:rightPath>fn:true()</con1:rightPath>
                                                </con1:compExpr>
                                            </con1:xqueryConditionExpr>
                                        </con2:condition>
                                        <con2:actions>
                                            <con2:Error>
                                                <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-6b99</con1:id>
                                                <con2:errCode>1</con2:errCode>
                                                <con2:message>El plan del cliente no es compatible con el plan configurado para la bolsa que desea aplicar</con2:message>
                                            </con2:Error>
                                        </con2:actions>
                                    </con2:case>
                                    <con2:default/>
                                </con2:ifThenElse>
                            </con2:actions>
                        </con2:case>
                        <con2:default>
                            <con2:Error>
                                <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-6b98</con1:id>
                                <con2:errCode>0101</con2:errCode>
                                <con2:message>no coincide con este flujo ICC.</con2:message>
                            </con2:Error>
                        </con2:default>
                    </con2:ifThenElse>
                </con:actions>
            </con:stage>
            <con:stage name="getDateDivVigencia">
                <con:context>
                    <con1:userNsDecl namespace="http://xmlns.oracle.com/pcbpel/adapter/db/DateSumVigenciaDba" prefix="dat"/>
                    <con1:varNsDecl namespace="http://captive.portal.ws.ncl.nii.com" prefix="cap"/>
                </con:context>
                <con:actions>
                    <con2:assign varName="vigenciaMin">
                        <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-6553</con1:id>
                        <con2:expr>
                            <con1:xqueryText>data($body/cap:setNextelActiveProduct/vigencia)</con1:xqueryText>
                        </con2:expr>
                    </con2:assign>
                    <con2:assign varName="valorDiv">
                        <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-651a</con1:id>
                        <con2:expr>
                            <con1:xqueryText>1440</con1:xqueryText>
                        </con2:expr>
                    </con2:assign>
                    <con2:assign varName="divVigencia">
                        <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-658b</con1:id>
                        <con2:expr>
                            <con1:xqueryText>xs:int($vigenciaMin)div(xs:int($valorDiv))</con1:xqueryText>
                        </con2:expr>
                    </con2:assign>
                    <con2:wsCallout>
                        <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-5ede</con1:id>
                        <con2:service xsi:type="ref:BusinessServiceRef" ref="PortalCautivo/Business Services/BSDateSumVigenciaDba" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                        <con2:operation>DateSumVigenciaDba</con2:operation>
                        <con2:request>
                            <con2:body>DateSumVigencia</con2:body>
                        </con2:request>
                        <con2:response>
                            <con2:body>DateSumVigenciaReponse</con2:body>
                        </con2:response>
                        <con2:requestTransform>
                            <con2:assign varName="DateSumVigencia">
                                <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-5ee8</con1:id>
                                <con2:expr>
                                    <con1:xqueryText>&lt;dat:DateSumVigenciaDbaInput xmlns:dat="http://xmlns.oracle.com/pcbpel/adapter/db/DateSumVigenciaDba">
    &lt;dat:MinVig>{data($body/cap:setNextelActiveProduct/vigencia)}&lt;/dat:MinVig>
&lt;/dat:DateSumVigenciaDbaInput></con1:xqueryText>
                                </con2:expr>
                            </con2:assign>
                        </con2:requestTransform>
                        <con2:responseTransform>
                            <con2:assign varName="DateSumVigReponse">
                                <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-5ee7</con1:id>
                                <con2:expr>
                                    <con1:xqueryText>$DateSumVigenciaReponse</con1:xqueryText>
                                </con2:expr>
                            </con2:assign>
                            <con2:assign varName="ActualDate">
                                <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-5ee6</con1:id>
                                <con2:expr>
                                    <con1:xqueryText>data($DateSumVigReponse/dat:DateSumVigenciaDbaOutput/dat:actualDate)</con1:xqueryText>
                                </con2:expr>
                            </con2:assign>
                            <con2:assign varName="TotalDate">
                                <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-5ee5</con1:id>
                                <con2:expr>
                                    <con1:xqueryText>data($DateSumVigReponse/dat:DateSumVigenciaDbaOutput/dat:totalDate)</con1:xqueryText>
                                </con2:expr>
                            </con2:assign>
                            <con2:assign varName="LCActualFecha">
                                <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-5ee4</con1:id>
                                <con2:expr>
                                    <con1:xqueryText>fn:substring(xs:string($ActualDate),0,fn:string-length(xs:string($ActualDate))-18)</con1:xqueryText>
                                </con2:expr>
                            </con2:assign>
                            <con2:assign varName="LCActualHora">
                                <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-5ee3</con1:id>
                                <con2:expr>
                                    <con1:xqueryText>fn:substring(xs:string($ActualDate),12,8)</con1:xqueryText>
                                </con2:expr>
                            </con2:assign>
                            <con2:assign varName="LCHora">
                                <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-5ee2</con1:id>
                                <con2:expr>
                                    <con1:xqueryText>fn:substring(xs:string($TotalDate),12,8)</con1:xqueryText>
                                </con2:expr>
                            </con2:assign>
                            <con2:assign varName="LCFecha">
                                <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-5ee1</con1:id>
                                <con2:expr>
                                    <con1:xqueryText>fn:substring(xs:string($TotalDate),0,fn:string-length(xs:string($TotalDate))-18)</con1:xqueryText>
                                </con2:expr>
                            </con2:assign>
                            <con2:assign varName="EndDateTime">
                                <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-5ee0</con1:id>
                                <con2:expr>
                                    <con1:xqueryText>fn:concat(fn-bea:date-to-string-with-format("yyyyMMdd",xs:date($LCFecha)),"",fn-bea:time-to-string-with-format("HHmmss",xs:time($LCHora)))</con1:xqueryText>
                                </con2:expr>
                            </con2:assign>
                            <con2:assign varName="StartDateTime">
                                <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-5edf</con1:id>
                                <con2:expr>
                                    <con1:xqueryText>fn:concat(fn-bea:date-to-string-with-format("yyyyMMdd",xs:date($LCActualFecha)),"",fn-bea:time-to-string-with-format("HHmmss",xs:time($LCActualHora)))</con1:xqueryText>
                                </con2:expr>
                            </con2:assign>
                            <con2:assign varName="fechaOCC">
                                <con1:id>_ActionId-3602376958848697374--7242e8b0.15d08bfc312.-7fb3</con1:id>
                                <con2:expr>
                                    <con1:xqueryText>$ActualDate</con1:xqueryText>
                                </con2:expr>
                            </con2:assign>
                        </con2:responseTransform>
                    </con2:wsCallout>
                </con:actions>
            </con:stage>
            <con:stage name="getSaldo">
                <con:context>
                    <con1:userNsDecl namespace="http://ws.nextel.cl/schemas/searchBalanceIcc/alcatel/getAllInformation" prefix="get"/>
                    <con1:varNsDecl namespace="http://captive.portal.ws.ncl.nii.com" prefix="cap"/>
                </con:context>
                <con:actions>
                    <con2:ifThenElse>
                        <con1:id>_ActionId-3602376958848697374--7242e8b0.15d08bfc312.-7f94</con1:id>
                        <con2:case>
                            <con2:condition>
                                <con1:xqueryText>$body/cap:setNextelActiveProduct/metodo_pago/text() = 'CONTRA_FACTURA'</con1:xqueryText>
                            </con2:condition>
                            <con2:actions/>
                        </con2:case>
                        <con2:default>
                            <con2:wsCallout>
                                <con1:id>_ActionId-3602376958848697374--7242e8b0.15d08bfc312.-7f8c</con1:id>
                                <con2:service xsi:type="ref:ProxyRef" ref="SearchBalancesICC/Proxy Services/PSSearchBalancesICCService" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                <con2:operation>getSearchBalanceIcc</con2:operation>
                                <con2:request>
                                    <con2:body>getSearchBalanceIcc</con2:body>
                                </con2:request>
                                <con2:response>
                                    <con2:body>getSearchBalanceIccRespo</con2:body>
                                </con2:response>
                                <con2:requestTransform>
                                    <con1:assign varName="getSearchBalanceIcc" xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                                        <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-3602376958848697374--7242e8b0.15d08bfc312.-7f8f</con5:id>
                                        <con1:expr>
                                            <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config"><![CDATA[<get:searchBalancesICC-request 	xmlns:get="http://ws.nextel.cl/schemas/searchBalanceIcc/alcatel/getAllInformation">
<!--Optional:-->
<get:phone_number>{data($body/cap:setNextelActiveProduct/phone_number)}</get:phone_number>
<!--Optional:-->
<get:detail_bucket>Y</get:detail_bucket>
</get:searchBalancesICC-request>]]></con5:xqueryText>
                                        </con1:expr>
                                    </con1:assign>
                                </con2:requestTransform>
                                <con2:responseTransform>
                                    <con2:assign varName="getSearchRespo">
                                        <con1:id>_ActionId-3602376958848697374--7242e8b0.15d08bfc312.-7f8e</con1:id>
                                        <con2:expr>
                                            <con1:xqueryText>$getSearchBalanceIccRespo</con1:xqueryText>
                                        </con2:expr>
                                    </con2:assign>
                                    <con2:assign varName="currentBalance">
                                        <con1:id>_ActionId-3602376958848697374--7242e8b0.15d08bfc312.-7f8d</con1:id>
                                        <con2:expr>
                                            <con1:xqueryText>data($getSearchRespo/get:totalBalance)</con1:xqueryText>
                                        </con2:expr>
                                    </con2:assign>
                                </con2:responseTransform>
                            </con2:wsCallout>
                            <con1:ifThenElse xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                                <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-3602376958848697374--7242e8b0.15d08bfc312.-7f89</con5:id>
                                <con1:case>
                                    <con1:condition>
                                        <con4:xqueryConditionExpr xmlns:con4="http://www.bea.com/wli/sb/stages/config">
                                            <con4:compExpr operator="&lt;">
                                                <con4:leftPath>xs:decimal($currentBalance)</con4:leftPath>
                                                <con4:rightPath>xs:decimal($body/cap:setNextelActiveProduct/tariff_prod)</con4:rightPath>
                                            </con4:compExpr>
                                        </con4:xqueryConditionExpr>
                                    </con1:condition>
                                    <con1:actions>
                                        <con1:Error>
                                            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-3602376958848697374--7242e8b0.15d08bfc312.-7f88</con5:id>
                                            <con1:errCode>1</con1:errCode>
                                            <con1:message>Saldo Insuficiente</con1:message>
                                        </con1:Error>
                                    </con1:actions>
                                </con1:case>
                                <con1:default/>
                            </con1:ifThenElse>
                        </con2:default>
                    </con2:ifThenElse>
                </con:actions>
            </con:stage>
            <con:stage name="getPpm">
                <con:context>
                    <con1:userNsDecl namespace="http://implementation.web.api.icc.services.osp.in.alcatel.com" prefix="ns"/>
                    <con1:userNsDecl namespace="http://ws.server.ws.nextel.devetel.cl/" prefix="ns2"/>
                    <con1:userNsDecl namespace="http://pojo.web.api.icc.services.osp.in.alcatel.com/xsd" prefix="ns3"/>
                    <con1:userNsDecl namespace="http://nii.com/EnterpriseProxyService/ServiceManagement/QueryAccountBalanceXSD/v1" prefix="v1"/>
                    <con1:varNsDecl namespace="http://captive.portal.ws.ncl.nii.com" prefix="cap"/>
                </con:context>
                <con:actions>
                    <con1:wsCallout xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                        <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-6ba8</con5:id>
                        <con1:service xsi:type="ref:ProxyRef" ref="Alcatel-HighLevelApiWS/SubscriberLineManager/Proxy Services/PSSubscriberLineManagerService" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                        <con1:operation>getAllInformation</con1:operation>
                        <con1:request>
                            <con1:body>getAllInformation</con1:body>
                        </con1:request>
                        <con1:response>
                            <con1:body>getAllInformationResponse</con1:body>
                        </con1:response>
                        <con1:requestTransform>
                            <con1:assign varName="getAllInformation">
                                <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-6bad</con5:id>
                                <con1:expr>
                                    <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config"><![CDATA[<imp:getAllInformation xmlns:imp="http://implementation.web.api.icc.services.osp.in.alcatel.com">
	<!--Optional:-->
	<imp:subscriberLineId>{data($body/cap:setNextelActiveProduct/phone_number)}</imp:subscriberLineId>
	<!--Optional:-->
	<imp:subscriberLineIdType>3</imp:subscriberLineIdType>
	<!--Optional:-->
	<imp:allBuckets></imp:allBuckets>
</imp:getAllInformation>]]></con5:xqueryText>
                                </con1:expr>
                            </con1:assign>
                        </con1:requestTransform>
                        <con1:responseTransform>
                            <con1:assign varName="getAllInformationRes">
                                <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-6bac</con5:id>
                                <con1:expr>
                                    <con4:xqueryText xmlns:con4="http://www.bea.com/wli/sb/stages/config">$getAllInformationResponse</con4:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:assign varName="ppm_ri">
                                <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-6bab</con5:id>
                                <con1:expr>
                                    <con4:xqueryText xmlns:con4="http://www.bea.com/wli/sb/stages/config">data($getAllInformationRes/ns:return/ns3:defaultAccountIdentifierLogin)</con4:xqueryText>
                                </con1:expr>
                            </con1:assign>
                            <con1:ifThenElse>
                                <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-6baa</con5:id>
                                <con1:case>
                                    <con1:condition>
                                        <con4:xqueryConditionExpr xmlns:con4="http://www.bea.com/wli/sb/stages/config">
                                            <con4:compExpr operator="=">
                                                <con4:leftPath>$ppm_ri</con4:leftPath>
                                                <con4:rightPath>''</con4:rightPath>
                                            </con4:compExpr>
                                        </con4:xqueryConditionExpr>
                                    </con1:condition>
                                    <con1:actions>
                                        <con1:Error>
                                            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-6ba9</con5:id>
                                            <con1:errCode>1</con1:errCode>
                                            <con1:message>Error: al obtener ppm_ri (Consulta ICC)</con1:message>
                                        </con1:Error>
                                    </con1:actions>
                                </con1:case>
                                <con1:default/>
                            </con1:ifThenElse>
                            <con1:assign varName="clien_ri">
                                <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-66d2</con5:id>
                                <con1:expr>
                                    <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">replace(normalize-space($ppm_ri),'A0','C')</con5:xqueryText>
                                </con1:expr>
                            </con1:assign>
                        </con1:responseTransform>
                    </con1:wsCallout>
                </con:actions>
            </con:stage>
            <con:stage name="Upselling">
                <con:context>
                    <con1:varNsDecl namespace="http://captive.portal.ws.ncl.nii.com" prefix="cap"/>
                </con:context>
                <con:actions>
                    <con2:wsCallout>
                        <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-7be4</con1:id>
                        <con2:service xsi:type="ref:ProxyRef" ref="PortalCautivo/Proxy Services/PSUpsellingCompraBolsas" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                        <con2:operation>getUpsellingCompraBolsas</con2:operation>
                        <con2:request>
                            <con2:body wrapped="false">upsellingReq</con2:body>
                        </con2:request>
                        <con2:response>
                            <con2:body>upsellingResp</con2:body>
                        </con2:response>
                        <con2:requestTransform>
                            <con2:assign varName="upsellingReq">
                                <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-7b58</con1:id>
                                <con2:expr>
                                    <con1:xqueryTransform>
                                        <con1:resource ref="PortalCautivo/Resources/XQuery/IN_XQ_PrepaidUpselling"/>
                                        <con1:param name="setNextelActiveProduct1">
                                            <con1:path>$body/cap:setNextelActiveProduct</con1:path>
                                        </con1:param>
                                    </con1:xqueryTransform>
                                </con2:expr>
                            </con2:assign>
                        </con2:requestTransform>
                        <con2:responseTransform>
                            <con2:assign varName="valorServicio">
                                <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-7a3f</con1:id>
                                <con2:expr>
                                    <con1:xqueryText>$upsellingResp/listaBundles/item_bundle/cod_pcrf</con1:xqueryText>
                                </con2:expr>
                            </con2:assign>
                            <con2:assign varName="validarServicio">
                                <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-7b20</con1:id>
                                <con2:expr>
                                    <con1:xqueryText>if(
data($upsellingResp/listaBundles/item_bundle/cod_pcrf)= data($body/cap:setNextelActiveProduct/id_pcrf_prod)) then
('true')
else(
'false'
)</con1:xqueryText>
                                </con2:expr>
                            </con2:assign>
                        </con2:responseTransform>
                    </con2:wsCallout>
                </con:actions>
            </con:stage>
            <con:stage name="getValidaAplicacionBolsa">
                <con:context>
                    <con1:userNsDecl namespace="http://xmlns.oracle.com/pcbpel/adapter/db/PROVI_BOLS/NII_BSCS_PORTAL_CAUTIVO_PKG/REGISTRA_ALTA_PRODUCTOS_PRC/" prefix="al"/>
                    <con1:userNsDecl namespace="http://xmlns.oracle.com/pcbpel/adapter/db/validaTransaccioDBA" prefix="val"/>
                    <con1:varNsDecl namespace="http://captive.portal.ws.ncl.nii.com" prefix="cap"/>
                </con:context>
                <con:actions>
                    <con2:ifThenElse>
                        <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-79d1</con1:id>
                        <con2:case>
                            <con2:condition>
                                <con1:xqueryConditionExpr>
                                    <con1:compExpr operator="=">
                                        <con1:leftPath>$validarServicio</con1:leftPath>
                                        <con1:rightPath>'true'</con1:rightPath>
                                    </con1:compExpr>
                                </con1:xqueryConditionExpr>
                            </con2:condition>
                            <con2:actions/>
                        </con2:case>
                        <con2:default>
                            <con2:Error>
                                <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-7963</con1:id>
                                <con2:errCode>1</con2:errCode>
                                <con2:message>El servicio no se encuentra en la oferta aplicable del Upselling</con2:message>
                            </con2:Error>
                        </con2:default>
                    </con2:ifThenElse>
                    <con2:assign varName="TypProdBscs">
                        <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-679c</con1:id>
                        <con2:expr>
                            <con1:xqueryText>if(data($body/cap:setNextelActiveProduct/type_prod_bscs) = 'BOL_MIX') then
('true')
else('false')</con1:xqueryText>
                        </con2:expr>
                    </con2:assign>
                    <con2:assign varName="kidPcrf">
                        <con1:id>_ActionId-6981365370467518964-7937cdca.15313be461e.-7fe4</con1:id>
                        <con2:expr>
                            <con1:xqueryText>if(empty(fn-bea:trim($body/cap:setNextelActiveProduct/servicioKidPcrf/text()))) then
('false')
else('true')</con1:xqueryText>
                        </con2:expr>
                    </con2:assign>
                    <con2:assign varName="trafixType">
                        <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-6423</con1:id>
                        <con2:expr>
                            <con1:xqueryText>data($body/cap:setNextelActiveProduct/traffic_type)</con1:xqueryText>
                        </con2:expr>
                    </con2:assign>
                    <con2:assign varName="kitVoz">
                        <con1:id>_ActionId-8898132218641135820--41ae47ed.153beee56f5.-7e54</con1:id>
                        <con2:expr>
                            <con1:xqueryText>if(empty(fn-bea:trim($body/cap:setNextelActiveProduct/unit_free/text()))) then
('false')
else('true')</con1:xqueryText>
                        </con2:expr>
                    </con2:assign>
                    <con2:assign varName="kitSms">
                        <con1:id>_ActionId-8898132218641135820--41ae47ed.153beee56f5.-7e53</con1:id>
                        <con2:expr>
                            <con1:xqueryText>if(empty(fn-bea:trim($body/cap:setNextelActiveProduct/file3/text()))) then
('false')
else('true')</con1:xqueryText>
                        </con2:expr>
                    </con2:assign>
                    <con2:assign varName="kitDatos">
                        <con1:id>_ActionId-8898132218641135820--41ae47ed.153beee56f5.-7e52</con1:id>
                        <con2:expr>
                            <con1:xqueryText>if(empty(fn-bea:trim($body/cap:setNextelActiveProduct/file2/text()))) then
('false')
else('true')</con1:xqueryText>
                        </con2:expr>
                    </con2:assign>
                </con:actions>
            </con:stage>
            <con:stage name="getSuscripcionesICC" errorHandler="_onErrorHandler-566152540498608711--41c73081.15ed54b404f.-77aa">
                <con:context>
                    <con1:userNsDecl namespace="http://implementation.web.api.icc.services.osp.in.alcatel.com" prefix="ns1"/>
                    <con1:userNsDecl namespace="http://pojo.web.api.icc.services.osp.in.alcatel.com/xsd" prefix="ns3"/>
                    <con1:varNsDecl namespace="http://captive.portal.ws.ncl.nii.com" prefix="cap"/>
                </con:context>
                <con:actions>
                    <con2:ifThenElse>
                        <con1:id>_ActionId-566152540498608711--41c73081.15ed54b404f.-77b1</con1:id>
                        <con2:case>
                            <con2:condition>
                                <con1:xqueryText>$body/cap:setNextelActiveProduct/tecnologia/text() = 'SUS'</con1:xqueryText>
                            </con2:condition>
                            <con2:actions>
                                <con2:wsCallout>
                                    <con1:id>_ActionId-566152540498608711--41c73081.15ed54b404f.-77ab</con1:id>
                                    <con2:service xsi:type="ref:BusinessServiceRef" ref="PortalCautivo/Business Services/BSSogSubscriptionManager" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                    <con2:operation>get</con2:operation>
                                    <con2:request>
                                        <con2:body>getRequest</con2:body>
                                    </con2:request>
                                    <con2:response>
                                        <con2:body>getResponse</con2:body>
                                    </con2:response>
                                    <con2:requestTransform>
                                        <con2:replace varName="getRequest">
                                            <con1:id>_ActionId-566152540498608711--41c73081.15ed54b404f.-77ad</con1:id>
                                            <con2:expr>
                                                <con1:xqueryTransform>
                                                    <con1:resource ref="PortalCautivo/Resources/XQuery/IN_XQ_SogSubscriptionManager_Get"/>
                                                    <con1:param name="suscripcion">
                                                        <con1:path>$body/cap:setNextelActiveProduct/id_pcrf_prod/text()</con1:path>
                                                    </con1:param>
                                                    <con1:param name="nrocelular">
                                                        <con1:path>$body/cap:setNextelActiveProduct/phone_number/text()</con1:path>
                                                    </con1:param>
                                                </con1:xqueryTransform>
                                            </con2:expr>
                                        </con2:replace>
                                    </con2:requestTransform>
                                    <con2:responseTransform>
                                        <con2:assign varName="statusSuscripcion">
                                            <con1:id>_ActionId-566152540498608711--41c73081.15ed54b404f.-77ac</con1:id>
                                            <con2:expr>
                                                <con1:xqueryText>$getResponse/ns1:return/ns3:state/text()</con1:xqueryText>
                                            </con2:expr>
                                        </con2:assign>
                                    </con2:responseTransform>
                                </con2:wsCallout>
                            </con2:actions>
                        </con2:case>
                        <con2:default/>
                    </con2:ifThenElse>
                </con:actions>
            </con:stage>
            <con:stage name="setAsignaBolsasDeposit" errorHandler="_onErrorHandler-7538415494247415963-6ca2b1e9.14e26b1c10e.-5fc8">
                <con:context>
                    <con1:userNsDecl namespace="http://ratingengine.web.api.icc.services.osp.in.alcatel.com" prefix="ns"/>
                    <con1:userNsDecl namespace="http://pojo.web.api.icc.services.osp.in.alcatel.com/xsd" prefix="ns3"/>
                    <con1:userNsDecl namespace="http://implementation.web.api.icc.services.osp.in.alcatel.com" prefix="ns1"/>
                    <con1:varNsDecl namespace="http://captive.portal.ws.ncl.nii.com" prefix="cap"/>
                </con:context>
                <con:actions>
                    <con2:ifThenElse>
                        <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-6764</con1:id>
                        <con2:case>
                            <con2:condition>
                                <con1:xqueryText>$body/cap:setNextelActiveProduct/tecnologia/text() = 'TEM'</con1:xqueryText>
                            </con2:condition>
                            <con2:actions>
                                <con2:assign varName="validExistICCvalue">
                                    <con1:id>_ActionId-3983233839552650961--de8752b.15d4d639764.-78c5</con1:id>
                                    <con2:expr>
                                        <con1:xqueryText>fn:count($getAllInformationRes/ns1:return/ns3:defaultAccount/ns3:buckets[ns3:usageLabelRef = $body/cap:setNextelActiveProduct/id_pcrf_prod/text()])</con1:xqueryText>
                                    </con2:expr>
                                </con2:assign>
                                <con1:ifThenElse xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                                    <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-3983233839552650961--de8752b.15d4d639764.-76fe</con5:id>
                                    <con1:case>
                                        <con1:condition>
                                            <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">xs:string($validExistICCvalue) = '0'</con5:xqueryText>
                                        </con1:condition>
                                        <con1:actions>
                                            <con1:wsCallout>
                                                <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-2394209408312488439-5d764665.15d94635027.-7fc5</con5:id>
                                                <con1:service xsi:type="ref:BusinessServiceRef" ref="PortalCautivo/Business Services/BSAccountManager" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                                <con1:operation>get</con1:operation>
                                                <con1:request>
                                                    <con1:body>getRequest</con1:body>
                                                </con1:request>
                                                <con1:response>
                                                    <con1:body>getResponse</con1:body>
                                                </con1:response>
                                                <con1:requestTransform>
                                                    <con1:replace varName="getRequest">
                                                        <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-2394209408312488439-5d764665.15d94635027.-7f20</con5:id>
                                                        <con1:expr>
                                                            <con5:xqueryTransform xmlns:con5="http://www.bea.com/wli/sb/stages/config">
                                                                <con5:resource ref="PortalCautivo/Resources/XQuery/IN_XQ_AccountManagerGet"/>
                                                                <con5:param name="nroCelular">
                                                                    <con5:path>$body/cap:setNextelActiveProduct/phone_number/text()</con5:path>
                                                                </con5:param>
                                                            </con5:xqueryTransform>
                                                        </con1:expr>
                                                    </con1:replace>
                                                </con1:requestTransform>
                                                <con1:responseTransform>
                                                    <con1:assign varName="validExistICCAccountvalue">
                                                        <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-2394209408312488439-5d764665.15d94635027.-7ee8</con5:id>
                                                        <con1:expr>
                                                            <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">fn:count($getResponse/ns1:return/ns3:buckets[ns3:usageLabelRef = $body/cap:setNextelActiveProduct/id_pcrf_prod/text()])</con5:xqueryText>
                                                        </con1:expr>
                                                    </con1:assign>
                                                    <con1:ifThenElse>
                                                        <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-2394209408312488439-5d764665.15d94635027.-7eb0</con5:id>
                                                        <con1:case>
                                                            <con1:condition>
                                                                <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">xs:string($validExistICCAccountvalue) = '0'</con5:xqueryText>
                                                            </con1:condition>
                                                            <con1:actions>
                                                                <con1:wsCallout>
                                                                    <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-2394209408312488439-5d764665.15d94635027.-7ea4</con5:id>
                                                                    <con1:service xsi:type="ref:BusinessServiceRef" ref="PortalCautivo/Business Services/BSBucketManager" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                                                    <con1:operation>create</con1:operation>
                                                                    <con1:request>
                                                                        <con1:body>createICCReq</con1:body>
                                                                    </con1:request>
                                                                    <con1:response>
                                                                        <con1:body>createICCResp</con1:body>
                                                                    </con1:response>
                                                                    <con1:requestTransform>
                                                                        <con1:replace varName="createICCReq">
                                                                            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-2394209408312488439-5d764665.15d94635027.-7ea9</con5:id>
                                                                            <con1:expr>
                                                                                <con5:xqueryTransform xmlns:con5="http://www.bea.com/wli/sb/stages/config">
                                                                                    <con5:resource ref="PortalCautivo/Resources/XQuery/IN_XQ_CreateBucketTematica"/>
                                                                                    <con5:param name="startDate">
                                                                                        <con5:path>$ActualDate</con5:path>
                                                                                    </con5:param>
                                                                                    <con5:param name="remainingUnits">
                                                                                        <con5:path>$body/cap:setNextelActiveProduct/unit_free/text()</con5:path>
                                                                                    </con5:param>
                                                                                    <con5:param name="phoneNumber">
                                                                                        <con5:path>$body/cap:setNextelActiveProduct/phone_number/text()</con5:path>
                                                                                    </con5:param>
                                                                                    <con5:param name="nombreBucket">
                                                                                        <con5:path>$body/cap:setNextelActiveProduct/id_pcrf_prod/text()</con5:path>
                                                                                    </con5:param>
                                                                                    <con5:param name="limitDate">
                                                                                        <con5:path>$TotalDate</con5:path>
                                                                                    </con5:param>
                                                                                </con5:xqueryTransform>
                                                                            </con1:expr>
                                                                        </con1:replace>
                                                                    </con1:requestTransform>
                                                                    <con1:responseTransform>
                                                                        <con1:assign varName="getCreateError">
                                                                            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-2394209408312488439-5d764665.15d94635027.-7ea8</con5:id>
                                                                            <con1:expr>
                                                                                <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">count($createICCResp/ns1:return[ns3:usageLabelRef = $body/cap:setNextelActiveProduct/id_pcrf_prod/text()])</con5:xqueryText>
                                                                            </con1:expr>
                                                                        </con1:assign>
                                                                        <con5:ifThenElse xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con2="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con1="http://www.bea.com/wli/sb/stages/config" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
                                                                            <con1:id>_ActionId-2394209408312488439-5d764665.15d94635027.-7ea7</con1:id>
                                                                            <con5:case>
                                                                                <con5:condition>
                                                                                    <con1:xqueryConditionExpr>
                                                                                        <con1:compExpr operator="=">
                                                                                            <con1:leftPath>xs:string($getCreateError)</con1:leftPath>
                                                                                            <con1:rightPath>'0'</con1:rightPath>
                                                                                        </con1:compExpr>
                                                                                    </con1:xqueryConditionExpr>
                                                                                </con5:condition>
                                                                                <con5:actions>
                                                                                    <con1:replace varName="body" contents-only="true" xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                                                                                        <con6:id xmlns:con6="http://www.bea.com/wli/sb/stages/config">_ActionId-2394209408312488439-5d764665.15d94635027.-7ea6</con6:id>
                                                                                        <con1:expr>
                                                                                            <con6:xqueryText xmlns:con6="http://www.bea.com/wli/sb/stages/config"><![CDATA[<cap:setNextelActiveProductResponse xmlns:cap="http://captive.portal.ws.ncl.nii.com">
   <error_code>1</error_code>
   <err_description>{concat('Error: al intentar crear la bolsa ICC Nivel: setAsignaBolsasDeposit')}</err_description>
</cap:setNextelActiveProductResponse>]]></con6:xqueryText>
                                                                                        </con1:expr>
                                                                                    </con1:replace>
                                                                                    <con4:reply isError="false" xmlns:con4="http://www.bea.com/wli/sb/stages/config" xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                                                                                        <con4:id>_ActionId-2394209408312488439-5d764665.15d94635027.-7ea5</con4:id>
                                                                                    </con4:reply>
                                                                                </con5:actions>
                                                                            </con5:case>
                                                                            <con5:default/>
                                                                        </con5:ifThenElse>
                                                                    </con1:responseTransform>
                                                                </con1:wsCallout>
                                                            </con1:actions>
                                                        </con1:case>
                                                        <con1:default>
                                                            <con1:assign varName="rowIdentifier">
                                                                <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-2394209408312488439-5d764665.15d94635027.-7dfb</con5:id>
                                                                <con1:expr>
                                                                    <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">$getResponse/ns1:return/ns3:buckets[ns3:usageLabelRef = $body/cap:setNextelActiveProduct/id_pcrf_prod/text()]/ns3:rowIdentifier/text()</con5:xqueryText>
                                                                </con1:expr>
                                                            </con1:assign>
                                                            <con1:wsCallout>
                                                                <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-2394209408312488439-5d764665.15d94635027.-7e6c</con5:id>
                                                                <con1:service xsi:type="ref:BusinessServiceRef" ref="PortalCautivo/Business Services/BSBucketManager" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                                                <con1:operation>modify</con1:operation>
                                                                <con1:request>
                                                                    <con1:body>bucketModifyRequest</con1:body>
                                                                </con1:request>
                                                                <con1:response>
                                                                    <con1:body>bucketModifyReponse</con1:body>
                                                                </con1:response>
                                                                <con1:requestTransform>
                                                                    <con1:replace varName="bucketModifyRequest">
                                                                        <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-2394209408312488439-5d764665.15d94635027.-7e33</con5:id>
                                                                        <con1:expr>
                                                                            <con5:xqueryTransform xmlns:con5="http://www.bea.com/wli/sb/stages/config">
                                                                                <con5:resource ref="PortalCautivo/Resources/XQuery/IN_XQ_BucketModify"/>
                                                                                <con5:param name="rowIdentifier">
                                                                                    <con5:path>$rowIdentifier</con5:path>
                                                                                </con5:param>
                                                                                <con5:param name="startDate">
                                                                                    <con5:path>$ActualDate</con5:path>
                                                                                </con5:param>
                                                                                <con5:param name="nroCelular">
                                                                                    <con5:path>$body/cap:setNextelActiveProduct/phone_number/text()</con5:path>
                                                                                </con5:param>
                                                                                <con5:param name="limitDate">
                                                                                    <con5:path>$TotalDate</con5:path>
                                                                                </con5:param>
                                                                                <con5:param name="units">
                                                                                    <con5:path>$body/cap:setNextelActiveProduct/unit_free/text()</con5:path>
                                                                                </con5:param>
                                                                            </con5:xqueryTransform>
                                                                        </con1:expr>
                                                                    </con1:replace>
                                                                </con1:requestTransform>
                                                                <con1:responseTransform>
                                                                    <con1:assign varName="bucketModifyError">
                                                                        <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-2394209408312488439-5d764665.15d94635027.-7dbc</con5:id>
                                                                        <con1:expr>
                                                                            <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">count($bucketModifyReponse/ns1:return[ns3:usageLabelRef = $body/cap:setNextelActiveProduct/id_pcrf_prod/text()])</con5:xqueryText>
                                                                        </con1:expr>
                                                                    </con1:assign>
                                                                    <con5:ifThenElse xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con2="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con1="http://www.bea.com/wli/sb/stages/config" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
                                                                        <con1:id>_ActionId-2394209408312488439-5d764665.15d94635027.-7dbb</con1:id>
                                                                        <con5:case>
                                                                            <con5:condition>
                                                                                <con1:xqueryConditionExpr>
                                                                                    <con1:compExpr operator="=">
                                                                                        <con1:leftPath>xs:string($bucketModifyError)</con1:leftPath>
                                                                                        <con1:rightPath>'0'</con1:rightPath>
                                                                                    </con1:compExpr>
                                                                                </con1:xqueryConditionExpr>
                                                                            </con5:condition>
                                                                            <con5:actions>
                                                                                <con1:replace varName="body" contents-only="true" xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                                                                                    <con6:id xmlns:con6="http://www.bea.com/wli/sb/stages/config">_ActionId-2394209408312488439-5d764665.15d94635027.-7dba</con6:id>
                                                                                    <con1:expr>
                                                                                        <con6:xqueryText xmlns:con6="http://www.bea.com/wli/sb/stages/config"><![CDATA[<cap:setNextelActiveProductResponse xmlns:cap="http://captive.portal.ws.ncl.nii.com">
   <error_code>1</error_code>
   <err_description>{concat('Error: al intentar crear la bolsa ICC Nivel: setAsignaBolsasDeposit')}</err_description>
</cap:setNextelActiveProductResponse>]]></con6:xqueryText>
                                                                                    </con1:expr>
                                                                                </con1:replace>
                                                                                <con4:reply isError="false" xmlns:con4="http://www.bea.com/wli/sb/stages/config" xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                                                                                    <con4:id>_ActionId-2394209408312488439-5d764665.15d94635027.-7db9</con4:id>
                                                                                </con4:reply>
                                                                            </con5:actions>
                                                                        </con5:case>
                                                                        <con5:default/>
                                                                    </con5:ifThenElse>
                                                                </con1:responseTransform>
                                                            </con1:wsCallout>
                                                        </con1:default>
                                                    </con1:ifThenElse>
                                                </con1:responseTransform>
                                            </con1:wsCallout>
                                        </con1:actions>
                                    </con1:case>
                                    <con1:default>
                                        <con5:replace varName="body" contents-only="true" xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con2="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con1="http://www.bea.com/wli/sb/stages/config" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
                                            <con1:id>_ActionId-3983233839552650961--de8752b.15d4d639764.-76f0</con1:id>
                                            <con5:expr>
                                                <con1:xqueryText><![CDATA[<cap:setNextelActiveProductResponse xmlns:cap="http://captive.portal.ws.ncl.nii.com">
 <error_code>5051</error_code>
 <err_description>Actualmente ya tienes una bolsa activa. Podras comprar otra una vez que esta expire.</err_description>
</cap:setNextelActiveProductResponse>]]></con1:xqueryText>
                                            </con5:expr>
                                        </con5:replace>
                                        <con1:reply isError="false" xmlns:con3="http://www.bea.com/wli/sb/stages/logging/config" xmlns:con2="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con1="http://www.bea.com/wli/sb/stages/config">
                                            <con1:id>_ActionId-3983233839552650961--de8752b.15d4d639764.-76ef</con1:id>
                                        </con1:reply>
                                    </con1:default>
                                </con1:ifThenElse>
                            </con2:actions>
                        </con2:case>
                        <con2:case>
                            <con2:condition>
                                <con1:xqueryText>$body/cap:setNextelActiveProduct/tecnologia/text() = 'BUC'</con1:xqueryText>
                            </con2:condition>
                            <con2:actions>
                                <con2:wsCallout>
                                    <con1:id>_ActionId-7582186579725742267-751f8c0a.1611e20cb42.-7ca4</con1:id>
                                    <con2:service xsi:type="ref:BusinessServiceRef" ref="PortalCautivo/Business Services/BSRatingEngineManager" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                    <con2:operation>depositDeposit</con2:operation>
                                    <con2:request>
                                        <con2:body wrapped="false">depositReq</con2:body>
                                    </con2:request>
                                    <con2:response>
                                        <con2:body wrapped="false">depositResp</con2:body>
                                    </con2:response>
                                    <con2:requestTransform>
                                        <con2:assign varName="depositReq">
                                            <con1:id>_ActionId-7582186579725742267-751f8c0a.1611e20cb42.-7cab</con1:id>
                                            <con2:expr>
                                                <con1:xqueryText><![CDATA[<rat:depositDeposit xmlns:rat="http://ratingengine.web.api.icc.services.osp.in.alcatel.com">
    <!--Optional:-->
    <rat:deposit xmlns:xsd="http://web.ratingengine.web.api.icc.services.osp.in.alcatel.com/xsd">
            <xsd:clien_ri>{$clien_ri}</xsd:clien_ri> 
            <!--Optional:-->
            <xsd:ppm_ri>{$ppm_ri}</xsd:ppm_ri>                
            <!--Optional:-->
            <xsd:servret>nextelret</xsd:servret>                
            <!--Zero or more repetitions:-->
            <xsd:usage>{$body/cap:setNextelActiveProduct/id_bscs_prod/text()}</xsd:usage>                        
            <!--Optional:-->
            <xsd:uscost>{data($body/cap:setNextelActiveProduct/unit_free)}</xsd:uscost>                      
            <!--Zero or more repetitions:-->
            <xsd:use_act>{$divVigencia}</xsd:use_act>                   
            <!--Zero or more repetitions:-->
            <xsd:usqty>{data($body/cap:setNextelActiveProduct/unit_free)}</xsd:usqty> 
            </rat:deposit>
</rat:depositDeposit>]]></con1:xqueryText>
                                            </con2:expr>
                                        </con2:assign>
                                    </con2:requestTransform>
                                    <con2:responseTransform>
                                        <con2:assign varName="valorOutDeposit">
                                            <con1:id>_ActionId-7582186579725742267-751f8c0a.1611e20cb42.-7caa</con1:id>
                                            <con2:expr>
                                                <con1:xqueryText>data($depositResp/ns:return)</con1:xqueryText>
                                            </con2:expr>
                                        </con2:assign>
                                        <con2:assign varName="validaOutDeposit">
                                            <con1:id>_ActionId-7582186579725742267-751f8c0a.1611e20cb42.-7ca9</con1:id>
                                            <con2:expr>
                                                <con1:xqueryText>contains(xs:string($valorOutDeposit),'Deposit successfull')</con1:xqueryText>
                                            </con2:expr>
                                        </con2:assign>
                                        <con2:ifThenElse>
                                            <con1:id>_ActionId-7582186579725742267-751f8c0a.1611e20cb42.-7ca8</con1:id>
                                            <con2:case>
                                                <con2:condition>
                                                    <con1:xqueryConditionExpr>
                                                        <con1:compExpr operator="!=">
                                                            <con1:leftPath>xs:boolean($planOK)</con1:leftPath>
                                                            <con1:rightPath>fn:true()</con1:rightPath>
                                                        </con1:compExpr>
                                                    </con1:xqueryConditionExpr>
                                                </con2:condition>
                                                <con2:actions>
                                                    <con1:replace varName="body" contents-only="true" xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                                                        <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-7582186579725742267-751f8c0a.1611e20cb42.-7ca6</con5:id>
                                                        <con1:expr>
                                                            <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config"><![CDATA[<cap:setNextelActiveProductResponse xmlns:cap="http://captive.portal.ws.ncl.nii.com">
   <error_code>1</error_code>
   <err_description>{concat('Error: en la aplicacion del ajuste bucket Nivel: setAsignaBolsasDeposit')}</err_description>
</cap:setNextelActiveProductResponse>]]></con5:xqueryText>
                                                        </con1:expr>
                                                    </con1:replace>
                                                    <con4:reply xmlns:con4="http://www.bea.com/wli/sb/stages/config" xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                                                        <con4:id>_ActionId-7582186579725742267-751f8c0a.1611e20cb42.-7ca5</con4:id>
                                                    </con4:reply>
                                                </con2:actions>
                                            </con2:case>
                                            <con2:default/>
                                        </con2:ifThenElse>
                                    </con2:responseTransform>
                                </con2:wsCallout>
                            </con2:actions>
                        </con2:case>
                        <con2:case>
                            <con2:condition>
                                <con1:xqueryText>$body/cap:setNextelActiveProduct/tecnologia/text() = 'SUS'</con1:xqueryText>
                            </con2:condition>
                            <con2:actions>
                                <con2:ifThenElse>
                                    <con1:id>_ActionId-566152540498608711--41c73081.15ed54b404f.-7d25</con1:id>
                                    <con2:case>
                                        <con2:condition>
                                            <con1:xqueryText>empty($statusSuscripcion) or xs:string($statusSuscripcion) = '00'</con1:xqueryText>
                                        </con2:condition>
                                        <con2:actions>
                                            <con2:wsCallout>
                                                <con1:id>_ActionId-566152540498608711--41c73081.15ed54b404f.-7bfd</con1:id>
                                                <con2:service xsi:type="ref:BusinessServiceRef" ref="PortalCautivo/Business Services/BSSogSubscriptionManager" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                                <con2:operation>create</con2:operation>
                                                <con2:request>
                                                    <con2:body>createRequest</con2:body>
                                                </con2:request>
                                                <con2:response>
                                                    <con2:body>createResponse</con2:body>
                                                </con2:response>
                                                <con2:requestTransform>
                                                    <con2:replace varName="createRequest">
                                                        <con1:id>_ActionId-566152540498608711--41c73081.15ed54b404f.-7bc5</con1:id>
                                                        <con2:expr>
                                                            <con1:xqueryTransform>
                                                                <con1:resource ref="PortalCautivo/Resources/XQuery/IN_XQ_SogSubscriptionManager_Create"/>
                                                                <con1:param name="suscripcion">
                                                                    <con1:path>$body/cap:setNextelActiveProduct/id_pcrf_prod/text()</con1:path>
                                                                </con1:param>
                                                                <con1:param name="nrocelular">
                                                                    <con1:path>$body/cap:setNextelActiveProduct/phone_number/text()</con1:path>
                                                                </con1:param>
                                                            </con1:xqueryTransform>
                                                        </con2:expr>
                                                    </con2:replace>
                                                </con2:requestTransform>
                                                <con2:responseTransform>
                                                    <con2:assign varName="CreateSuscripcionRes">
                                                        <con1:id>_ActionId-566152540498608711--41c73081.15ed54b404f.-7b70</con1:id>
                                                        <con2:expr>
                                                            <con1:xqueryText>$createResponse/ns1:return/ns3:state/text()</con1:xqueryText>
                                                        </con2:expr>
                                                    </con2:assign>
                                                    <con2:ifThenElse>
                                                        <con1:id>_ActionId-566152540498608711--41c73081.15ed54b404f.-7b1d</con1:id>
                                                        <con2:case>
                                                            <con2:condition>
                                                                <con1:xqueryText>xs:string($CreateSuscripcionRes) = '0' or xs:string($CreateSuscripcionRes) = '1'</con1:xqueryText>
                                                            </con2:condition>
                                                            <con2:actions/>
                                                        </con2:case>
                                                        <con2:default>
                                                            <con5:replace varName="body" contents-only="true" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
                                                                <con1:id>_ActionId-566152540498608711--41c73081.15ed54b404f.-7ae2</con1:id>
                                                                <con5:expr>
                                                                    <con1:xqueryText><![CDATA[<cap:setNextelActiveProductResponse xmlns:cap="http://captive.portal.ws.ncl.nii.com">
 <error_code>5051</error_code>
 <err_description>Mala noticia, tu bolsa no ha sido activada, por favor prueba nuevamente.</err_description>
</cap:setNextelActiveProductResponse>]]></con1:xqueryText>
                                                                </con5:expr>
                                                            </con5:replace>
                                                            <con1:reply isError="false">
                                                                <con1:id>_ActionId-566152540498608711--41c73081.15ed54b404f.-7ae1</con1:id>
                                                            </con1:reply>
                                                        </con2:default>
                                                    </con2:ifThenElse>
                                                </con2:responseTransform>
                                            </con2:wsCallout>
                                        </con2:actions>
                                    </con2:case>
                                    <con2:case>
                                        <con2:condition>
                                            <con1:xqueryText>xs:string($statusSuscripcion) = '0'</con1:xqueryText>
                                        </con2:condition>
                                        <con2:actions>
                                            <con5:replace varName="body" contents-only="true" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
                                                <con1:id>_ActionId-566152540498608711--41c73081.15ed54b404f.-7c36</con1:id>
                                                <con5:expr>
                                                    <con1:xqueryText><![CDATA[<cap:setNextelActiveProductResponse xmlns:cap="http://captive.portal.ws.ncl.nii.com">
 <error_code>5055</error_code>
 <err_description>Actualmente ya tienes tu bolsa creada. Espera unos minutos para que se active.</err_description>
</cap:setNextelActiveProductResponse>]]></con1:xqueryText>
                                                </con5:expr>
                                            </con5:replace>
                                            <con1:reply isError="false">
                                                <con1:id>_ActionId-566152540498608711--41c73081.15ed54b404f.-7c35</con1:id>
                                            </con1:reply>
                                        </con2:actions>
                                    </con2:case>
                                    <con2:case>
                                        <con2:condition>
                                            <con1:xqueryText>xs:string($statusSuscripcion) = '1'</con1:xqueryText>
                                        </con2:condition>
                                        <con2:actions>
                                            <con5:replace varName="body" contents-only="true" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
                                                <con1:id>_ActionId-566152540498608711--41c73081.15ed54b404f.-7c3b</con1:id>
                                                <con5:expr>
                                                    <con1:xqueryText><![CDATA[<cap:setNextelActiveProductResponse xmlns:cap="http://captive.portal.ws.ncl.nii.com">
 <error_code>5051</error_code>
 <err_description>Actualmente ya tienes una bolsa activa. Podras comprar otra una vez que esta expire.</err_description>
</cap:setNextelActiveProductResponse>]]></con1:xqueryText>
                                                </con5:expr>
                                            </con5:replace>
                                            <con1:reply isError="false">
                                                <con1:id>_ActionId-566152540498608711--41c73081.15ed54b404f.-7c39</con1:id>
                                            </con1:reply>
                                        </con2:actions>
                                    </con2:case>
                                    <con2:case>
                                        <con2:condition>
                                            <con1:xqueryText>xs:string($statusSuscripcion) = '5'</con1:xqueryText>
                                        </con2:condition>
                                        <con2:actions>
                                            <con2:wsCallout>
                                                <con1:id>_ActionId-566152540498608711--41c73081.15ed54b404f.-7aa9</con1:id>
                                                <con2:service xsi:type="ref:BusinessServiceRef" ref="PortalCautivo/Business Services/BSSogSubscriptionManager" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                                <con2:operation>modify</con2:operation>
                                                <con2:request>
                                                    <con2:body>modifyRequest</con2:body>
                                                </con2:request>
                                                <con2:response>
                                                    <con2:body>modifyResponse</con2:body>
                                                </con2:response>
                                                <con2:requestTransform>
                                                    <con2:replace varName="modifyRequest">
                                                        <con1:id>_ActionId-566152540498608711--41c73081.15ed54b404f.-7a70</con1:id>
                                                        <con2:expr>
                                                            <con1:xqueryTransform>
                                                                <con1:resource ref="PortalCautivo/Resources/XQuery/IN_XQ_SogSubscriptionManager_Modify"/>
                                                                <con1:param name="suscripcion">
                                                                    <con1:path>$body/cap:setNextelActiveProduct/id_pcrf_prod/text()</con1:path>
                                                                </con1:param>
                                                                <con1:param name="nrocelular">
                                                                    <con1:path>$body/cap:setNextelActiveProduct/phone_number/text()</con1:path>
                                                                </con1:param>
                                                            </con1:xqueryTransform>
                                                        </con2:expr>
                                                    </con2:replace>
                                                </con2:requestTransform>
                                                <con2:responseTransform/>
                                            </con2:wsCallout>
                                            <con2:wsCallout>
                                                <con1:id>_ActionId-566152540498608711--41c73081.15ed54b404f.-7a36</con1:id>
                                                <con2:service xsi:type="ref:BusinessServiceRef" ref="PortalCautivo/Business Services/BSSogSubscriptionManager" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                                <con2:operation>remove</con2:operation>
                                                <con2:request>
                                                    <con2:body>removeRequest</con2:body>
                                                </con2:request>
                                                <con2:response>
                                                    <con2:body>removeResponse</con2:body>
                                                </con2:response>
                                                <con2:requestTransform>
                                                    <con2:replace varName="removeRequest">
                                                        <con1:id>_ActionId-566152540498608711--41c73081.15ed54b404f.-79fd</con1:id>
                                                        <con2:expr>
                                                            <con1:xqueryTransform>
                                                                <con1:resource ref="PortalCautivo/Resources/XQuery/IN_XQ_SogSubscriptionManager_Remove"/>
                                                                <con1:param name="suscripcion">
                                                                    <con1:path>$body/cap:setNextelActiveProduct/id_pcrf_prod/text()</con1:path>
                                                                </con1:param>
                                                                <con1:param name="nrocelular">
                                                                    <con1:path>$body/cap:setNextelActiveProduct/phone_number/text()</con1:path>
                                                                </con1:param>
                                                            </con1:xqueryTransform>
                                                        </con2:expr>
                                                    </con2:replace>
                                                </con2:requestTransform>
                                                <con2:responseTransform/>
                                            </con2:wsCallout>
                                            <con2:wsCallout>
                                                <con1:id>_ActionId-566152540498608711--41c73081.15ed54b404f.-7973</con1:id>
                                                <con2:service xsi:type="ref:BusinessServiceRef" ref="PortalCautivo/Business Services/BSSogSubscriptionManager" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                                <con2:operation>create</con2:operation>
                                                <con2:request>
                                                    <con2:body>createRequest</con2:body>
                                                </con2:request>
                                                <con2:response>
                                                    <con2:body>createResponse</con2:body>
                                                </con2:response>
                                                <con2:requestTransform>
                                                    <con2:replace varName="createRequest">
                                                        <con1:id>_ActionId-566152540498608711--41c73081.15ed54b404f.-7978</con1:id>
                                                        <con2:expr>
                                                            <con1:xqueryTransform>
                                                                <con1:resource ref="PortalCautivo/Resources/XQuery/IN_XQ_SogSubscriptionManager_Create"/>
                                                                <con1:param name="suscripcion">
                                                                    <con1:path>$body/cap:setNextelActiveProduct/id_pcrf_prod/text()</con1:path>
                                                                </con1:param>
                                                                <con1:param name="nrocelular">
                                                                    <con1:path>$body/cap:setNextelActiveProduct/phone_number/text()</con1:path>
                                                                </con1:param>
                                                            </con1:xqueryTransform>
                                                        </con2:expr>
                                                    </con2:replace>
                                                </con2:requestTransform>
                                                <con2:responseTransform>
                                                    <con2:assign varName="CreateSuscripcionRes">
                                                        <con1:id>_ActionId-566152540498608711--41c73081.15ed54b404f.-7977</con1:id>
                                                        <con2:expr>
                                                            <con1:xqueryText>$createResponse/ns1:return/ns3:state/text()</con1:xqueryText>
                                                        </con2:expr>
                                                    </con2:assign>
                                                    <con2:ifThenElse>
                                                        <con1:id>_ActionId-566152540498608711--41c73081.15ed54b404f.-7976</con1:id>
                                                        <con2:case>
                                                            <con2:condition>
                                                                <con1:xqueryText>xs:string($CreateSuscripcionRes) = '0' or xs:string($CreateSuscripcionRes) = '1'</con1:xqueryText>
                                                            </con2:condition>
                                                            <con2:actions/>
                                                        </con2:case>
                                                        <con2:default>
                                                            <con5:replace varName="body" contents-only="true" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
                                                                <con1:id>_ActionId-566152540498608711--41c73081.15ed54b404f.-7975</con1:id>
                                                                <con5:expr>
                                                                    <con1:xqueryText><![CDATA[<cap:setNextelActiveProductResponse xmlns:cap="http://captive.portal.ws.ncl.nii.com">
 <error_code>5051</error_code>
 <err_description>Mala noticia, tu bolsa no ha sido activada, por favor prueba nuevamente.</err_description>
</cap:setNextelActiveProductResponse>]]></con1:xqueryText>
                                                                </con5:expr>
                                                            </con5:replace>
                                                            <con1:reply isError="false">
                                                                <con1:id>_ActionId-566152540498608711--41c73081.15ed54b404f.-7974</con1:id>
                                                            </con1:reply>
                                                        </con2:default>
                                                    </con2:ifThenElse>
                                                </con2:responseTransform>
                                            </con2:wsCallout>
                                        </con2:actions>
                                    </con2:case>
                                    <con2:default>
                                        <con5:replace varName="body" contents-only="true" xmlns:con5="http://www.bea.com/wli/sb/stages/transform/config">
                                            <con1:id>_ActionId-566152540498608711--41c73081.15ed54b404f.-78c8</con1:id>
                                            <con5:expr>
                                                <con1:xqueryText><![CDATA[<cap:setNextelActiveProductResponse xmlns:cap="http://captive.portal.ws.ncl.nii.com">
 <error_code>5060</error_code>
 <err_description>La suscripcion se encuentra en un estado desconocido.</err_description>
</cap:setNextelActiveProductResponse>]]></con1:xqueryText>
                                            </con5:expr>
                                        </con5:replace>
                                        <con1:reply isError="false">
                                            <con1:id>_ActionId-566152540498608711--41c73081.15ed54b404f.-78c7</con1:id>
                                        </con1:reply>
                                    </con2:default>
                                </con2:ifThenElse>
                            </con2:actions>
                        </con2:case>
                        <con2:case>
                            <con2:condition>
                                <con1:xqueryConditionExpr>
                                    <con1:boolExpr operator="and">
                                        <con1:compExpr operator="=">
                                            <con1:leftPath>xs:boolean($TypProdBscs)</con1:leftPath>
                                            <con1:rightPath>xs:boolean('true')</con1:rightPath>
                                        </con1:compExpr>
                                        <con1:compExpr operator="=">
                                            <con1:leftPath>xs:boolean($kidPcrf)</con1:leftPath>
                                            <con1:rightPath>xs:boolean('false')</con1:rightPath>
                                        </con1:compExpr>
                                    </con1:boolExpr>
                                </con1:xqueryConditionExpr>
                            </con2:condition>
                            <con2:actions>
                                <con2:ifThenElse>
                                    <con1:id>_ActionId-412899736946124380--6c6ddce4.15d3e7cae0a.-7ea1</con1:id>
                                    <con2:case>
                                        <con2:condition>
                                            <con1:xqueryText>xs:boolean($kitSms) = xs:boolean('true')</con1:xqueryText>
                                        </con2:condition>
                                        <con2:actions>
                                            <con2:wsCallout>
                                                <con1:id>_ActionId-412899736946124380--6c6ddce4.15d3e7cae0a.-7e99</con1:id>
                                                <con2:service xsi:type="ref:BusinessServiceRef" ref="PortalCautivo/Business Services/BSRatingEngineManager" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                                <con2:operation>depositDeposit</con2:operation>
                                                <con2:request>
                                                    <con2:body wrapped="false">depositReq</con2:body>
                                                </con2:request>
                                                <con2:response>
                                                    <con2:body wrapped="false">depositResp</con2:body>
                                                </con2:response>
                                                <con2:requestTransform>
                                                    <con2:assign varName="depositReq">
                                                        <con1:id>_ActionId-412899736946124380--6c6ddce4.15d3e7cae0a.-7ea0</con1:id>
                                                        <con2:expr>
                                                            <con1:xqueryText><![CDATA[<rat:depositDeposit xmlns:rat="http://ratingengine.web.api.icc.services.osp.in.alcatel.com">
         <rat:deposit xmlns:xsd="http://web.ratingengine.web.api.icc.services.osp.in.alcatel.com/xsd">
            <xsd:clien_ri>{$clien_ri}</xsd:clien_ri> 
            <xsd:ppm_ri>{$ppm_ri}</xsd:ppm_ri>                
            <xsd:servret>nextelret</xsd:servret>         
            <!--INICIO SMS:-->
            <xsd:usage>SMS_UND_VENTA</xsd:usage>                        
			<xsd:uscost>{data($body/cap:setNextelActiveProduct/file3)}</xsd:uscost>                    
			<xsd:use_act>{$divVigencia}</xsd:use_act>
            <xsd:usqty>{data($body/cap:setNextelActiveProduct/file3)}</xsd:usqty>
		    <!--FIN SMS:-->
            </rat:deposit>
</rat:depositDeposit>]]></con1:xqueryText>
                                                        </con2:expr>
                                                    </con2:assign>
                                                </con2:requestTransform>
                                                <con2:responseTransform>
                                                    <con2:assign varName="valorOutDeposit">
                                                        <con1:id>_ActionId-412899736946124380--6c6ddce4.15d3e7cae0a.-7e9f</con1:id>
                                                        <con2:expr>
                                                            <con1:xqueryText>data($depositResp/ns:return)</con1:xqueryText>
                                                        </con2:expr>
                                                    </con2:assign>
                                                    <con2:assign varName="validaOutDeposit">
                                                        <con1:id>_ActionId-412899736946124380--6c6ddce4.15d3e7cae0a.-7e9e</con1:id>
                                                        <con2:expr>
                                                            <con1:xqueryText>contains(xs:string($valorOutDeposit),'Deposit successfull')</con1:xqueryText>
                                                        </con2:expr>
                                                    </con2:assign>
                                                    <con2:ifThenElse>
                                                        <con1:id>_ActionId-412899736946124380--6c6ddce4.15d3e7cae0a.-7e9d</con1:id>
                                                        <con2:case>
                                                            <con2:condition>
                                                                <con1:xqueryConditionExpr>
                                                                    <con1:compExpr operator="!=">
                                                                        <con1:leftPath>xs:boolean($planOK)</con1:leftPath>
                                                                        <con1:rightPath>fn:true()</con1:rightPath>
                                                                    </con1:compExpr>
                                                                </con1:xqueryConditionExpr>
                                                            </con2:condition>
                                                            <con2:actions>
                                                                <con1:replace varName="body" contents-only="true" xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                                                                    <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-412899736946124380--6c6ddce4.15d3e7cae0a.-7e9b</con5:id>
                                                                    <con1:expr>
                                                                        <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config"><![CDATA[<cap:setNextelActiveProductResponse xmlns:cap="http://captive.portal.ws.ncl.nii.com">
   <error_code>1</error_code>
   <err_description>{concat('Error: en la aplicacion del ajuste bucket Sms Nivel: setAsignaBolsasDeposit')}</err_description>
</cap:setNextelActiveProductResponse>]]></con5:xqueryText>
                                                                    </con1:expr>
                                                                </con1:replace>
                                                                <con4:reply xmlns:con4="http://www.bea.com/wli/sb/stages/config" xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                                                                    <con4:id>_ActionId-412899736946124380--6c6ddce4.15d3e7cae0a.-7e9a</con4:id>
                                                                </con4:reply>
                                                            </con2:actions>
                                                        </con2:case>
                                                        <con2:default/>
                                                    </con2:ifThenElse>
                                                </con2:responseTransform>
                                            </con2:wsCallout>
                                        </con2:actions>
                                    </con2:case>
                                    <con2:default/>
                                </con2:ifThenElse>
                                <con2:ifThenElse>
                                    <con1:id>_ActionId-412899736946124380--6c6ddce4.15d3e7cae0a.-7e98</con1:id>
                                    <con2:case>
                                        <con2:condition>
                                            <con1:xqueryText>xs:boolean($kitDatos) = xs:boolean('true')</con1:xqueryText>
                                        </con2:condition>
                                        <con2:actions>
                                            <con2:wsCallout>
                                                <con1:id>_ActionId-412899736946124380--6c6ddce4.15d3e7cae0a.-7e90</con1:id>
                                                <con2:service xsi:type="ref:BusinessServiceRef" ref="PortalCautivo/Business Services/BSRatingEngineManager" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                                <con2:operation>depositDeposit</con2:operation>
                                                <con2:request>
                                                    <con2:body wrapped="false">depositReq</con2:body>
                                                </con2:request>
                                                <con2:response>
                                                    <con2:body wrapped="false">depositResp</con2:body>
                                                </con2:response>
                                                <con2:requestTransform>
                                                    <con2:assign varName="depositReq">
                                                        <con1:id>_ActionId-412899736946124380--6c6ddce4.15d3e7cae0a.-7e97</con1:id>
                                                        <con2:expr>
                                                            <con1:xqueryText><![CDATA[<rat:depositDeposit xmlns:rat="http://ratingengine.web.api.icc.services.osp.in.alcatel.com">
         <rat:deposit xmlns:xsd="http://web.ratingengine.web.api.icc.services.osp.in.alcatel.com/xsd">
            <xsd:clien_ri>{$clien_ri}</xsd:clien_ri> 
            <xsd:ppm_ri>{$ppm_ri}</xsd:ppm_ri>                
            <xsd:servret>nextelret</xsd:servret>         
		    <!--INICIO DATOS:-->
		    <xsd:usage>DATOS_VOL_VENTA</xsd:usage>                        
			<xsd:uscost>{data($body/cap:setNextelActiveProduct/file2)}</xsd:uscost>                    
			<xsd:use_act>{$divVigencia}</xsd:use_act>                       
            <xsd:usqty>{data($body/cap:setNextelActiveProduct/file2)}</xsd:usqty>
            <!--FIN DATOS:-->
            </rat:deposit>
</rat:depositDeposit>]]></con1:xqueryText>
                                                        </con2:expr>
                                                    </con2:assign>
                                                </con2:requestTransform>
                                                <con2:responseTransform>
                                                    <con2:assign varName="valorOutDeposit">
                                                        <con1:id>_ActionId-412899736946124380--6c6ddce4.15d3e7cae0a.-7e96</con1:id>
                                                        <con2:expr>
                                                            <con1:xqueryText>data($depositResp/ns:return)</con1:xqueryText>
                                                        </con2:expr>
                                                    </con2:assign>
                                                    <con2:assign varName="validaOutDeposit">
                                                        <con1:id>_ActionId-412899736946124380--6c6ddce4.15d3e7cae0a.-7e95</con1:id>
                                                        <con2:expr>
                                                            <con1:xqueryText>contains(xs:string($valorOutDeposit),'Deposit successfull')</con1:xqueryText>
                                                        </con2:expr>
                                                    </con2:assign>
                                                    <con2:ifThenElse>
                                                        <con1:id>_ActionId-412899736946124380--6c6ddce4.15d3e7cae0a.-7e94</con1:id>
                                                        <con2:case>
                                                            <con2:condition>
                                                                <con1:xqueryConditionExpr>
                                                                    <con1:compExpr operator="!=">
                                                                        <con1:leftPath>xs:boolean($planOK)</con1:leftPath>
                                                                        <con1:rightPath>fn:true()</con1:rightPath>
                                                                    </con1:compExpr>
                                                                </con1:xqueryConditionExpr>
                                                            </con2:condition>
                                                            <con2:actions>
                                                                <con1:replace varName="body" contents-only="true" xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                                                                    <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-412899736946124380--6c6ddce4.15d3e7cae0a.-7e92</con5:id>
                                                                    <con1:expr>
                                                                        <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config"><![CDATA[<cap:setNextelActiveProductResponse xmlns:cap="http://captive.portal.ws.ncl.nii.com">
   <error_code>1</error_code>
   <err_description>{concat('Error: en la aplicacion del ajuste bucket Datos Nivel: setAsignaBolsasDeposit')}</err_description>
</cap:setNextelActiveProductResponse>]]></con5:xqueryText>
                                                                    </con1:expr>
                                                                </con1:replace>
                                                                <con4:reply xmlns:con4="http://www.bea.com/wli/sb/stages/config" xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                                                                    <con4:id>_ActionId-412899736946124380--6c6ddce4.15d3e7cae0a.-7e91</con4:id>
                                                                </con4:reply>
                                                            </con2:actions>
                                                        </con2:case>
                                                        <con2:default/>
                                                    </con2:ifThenElse>
                                                </con2:responseTransform>
                                            </con2:wsCallout>
                                        </con2:actions>
                                    </con2:case>
                                    <con2:default/>
                                </con2:ifThenElse>
                                <con2:ifThenElse>
                                    <con1:id>_ActionId-412899736946124380--6c6ddce4.15d3e7cae0a.-7e8f</con1:id>
                                    <con2:case>
                                        <con2:condition>
                                            <con1:xqueryText>xs:boolean($kitVoz) = xs:boolean('true')</con1:xqueryText>
                                        </con2:condition>
                                        <con2:actions>
                                            <con2:wsCallout>
                                                <con1:id>_ActionId-412899736946124380--6c6ddce4.15d3e7cae0a.-7e87</con1:id>
                                                <con2:service xsi:type="ref:BusinessServiceRef" ref="PortalCautivo/Business Services/BSRatingEngineManager" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                                <con2:operation>depositDeposit</con2:operation>
                                                <con2:request>
                                                    <con2:body wrapped="false">depositReq</con2:body>
                                                </con2:request>
                                                <con2:response>
                                                    <con2:body wrapped="false">depositResp</con2:body>
                                                </con2:response>
                                                <con2:requestTransform>
                                                    <con2:assign varName="depositReq">
                                                        <con1:id>_ActionId-412899736946124380--6c6ddce4.15d3e7cae0a.-7e8e</con1:id>
                                                        <con2:expr>
                                                            <con1:xqueryText><![CDATA[<rat:depositDeposit xmlns:rat="http://ratingengine.web.api.icc.services.osp.in.alcatel.com">
         <rat:deposit xmlns:xsd="http://web.ratingengine.web.api.icc.services.osp.in.alcatel.com/xsd">
            <xsd:clien_ri>{$clien_ri}</xsd:clien_ri> 
            <xsd:ppm_ri>{$ppm_ri}</xsd:ppm_ri>                
            <xsd:servret>nextelret</xsd:servret>         
            <!--INICIO VOZ:-->
            <xsd:usage>VOZ_VOL_VENTA</xsd:usage>                        
            <xsd:uscost>{data($body/cap:setNextelActiveProduct/unit_free)}</xsd:uscost>                      
            <xsd:use_act>{$divVigencia}</xsd:use_act>                   
            <xsd:usqty>{data($body/cap:setNextelActiveProduct/unit_free)}</xsd:usqty> 
            <!--FIN VOZ:-->
            </rat:deposit>
</rat:depositDeposit>]]></con1:xqueryText>
                                                        </con2:expr>
                                                    </con2:assign>
                                                </con2:requestTransform>
                                                <con2:responseTransform>
                                                    <con2:assign varName="valorOutDeposit">
                                                        <con1:id>_ActionId-412899736946124380--6c6ddce4.15d3e7cae0a.-7e8d</con1:id>
                                                        <con2:expr>
                                                            <con1:xqueryText>data($depositResp/ns:return)</con1:xqueryText>
                                                        </con2:expr>
                                                    </con2:assign>
                                                    <con2:assign varName="validaOutDeposit">
                                                        <con1:id>_ActionId-412899736946124380--6c6ddce4.15d3e7cae0a.-7e8c</con1:id>
                                                        <con2:expr>
                                                            <con1:xqueryText>contains(xs:string($valorOutDeposit),'Deposit successfull')</con1:xqueryText>
                                                        </con2:expr>
                                                    </con2:assign>
                                                    <con2:ifThenElse>
                                                        <con1:id>_ActionId-412899736946124380--6c6ddce4.15d3e7cae0a.-7e8b</con1:id>
                                                        <con2:case>
                                                            <con2:condition>
                                                                <con1:xqueryConditionExpr>
                                                                    <con1:compExpr operator="!=">
                                                                        <con1:leftPath>xs:boolean($planOK)</con1:leftPath>
                                                                        <con1:rightPath>fn:true()</con1:rightPath>
                                                                    </con1:compExpr>
                                                                </con1:xqueryConditionExpr>
                                                            </con2:condition>
                                                            <con2:actions>
                                                                <con1:replace varName="body" contents-only="true" xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                                                                    <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-412899736946124380--6c6ddce4.15d3e7cae0a.-7e89</con5:id>
                                                                    <con1:expr>
                                                                        <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config"><![CDATA[<cap:setNextelActiveProductResponse xmlns:cap="http://captive.portal.ws.ncl.nii.com">
   <error_code>1</error_code>
   <err_description>{concat('Error: en la aplicacion del ajuste bucket Voz Nivel: setAsignaBolsasDeposit')}</err_description>
</cap:setNextelActiveProductResponse>]]></con5:xqueryText>
                                                                    </con1:expr>
                                                                </con1:replace>
                                                                <con4:reply xmlns:con4="http://www.bea.com/wli/sb/stages/config" xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                                                                    <con4:id>_ActionId-412899736946124380--6c6ddce4.15d3e7cae0a.-7e88</con4:id>
                                                                </con4:reply>
                                                            </con2:actions>
                                                        </con2:case>
                                                        <con2:default/>
                                                    </con2:ifThenElse>
                                                </con2:responseTransform>
                                            </con2:wsCallout>
                                        </con2:actions>
                                    </con2:case>
                                    <con2:default/>
                                </con2:ifThenElse>
                            </con2:actions>
                        </con2:case>
                        <con2:case>
                            <con2:condition>
                                <con1:xqueryConditionExpr>
                                    <con1:boolExpr operator="and">
                                        <con1:compExpr operator="=">
                                            <con1:leftPath>xs:boolean($TypProdBscs)</con1:leftPath>
                                            <con1:rightPath>xs:boolean('true')</con1:rightPath>
                                        </con1:compExpr>
                                        <con1:compExpr operator="=">
                                            <con1:leftPath>xs:boolean($kidPcrf)</con1:leftPath>
                                            <con1:rightPath>xs:boolean('true')</con1:rightPath>
                                        </con1:compExpr>
                                    </con1:boolExpr>
                                </con1:xqueryConditionExpr>
                            </con2:condition>
                            <con2:actions>
                                <con2:wsCallout>
                                    <con1:id>_ActionId-3135677001892557768-780c3176.15361e86124.-78f3</con1:id>
                                    <con2:service ref="PortalCautivo/Proxy Services/LCPSDesactivaSRV" xsi:type="con:PipelineRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                    <con2:operation>setNextelActiveProduct</con2:operation>
                                    <con2:request>
                                        <con2:body>desactivaReq</con2:body>
                                    </con2:request>
                                    <con2:response>
                                        <con2:body>desactivaResp</con2:body>
                                    </con2:response>
                                    <con2:requestTransform>
                                        <con2:assign varName="desactivaReq">
                                            <con1:id>_ActionId-3135677001892557768-780c3176.15361e86124.-78fd</con1:id>
                                            <con2:expr>
                                                <con1:xqueryText><![CDATA[<cap:setNextelActiveProduct xmlns:cap="http://captive.portal.ws.ncl.nii.com">
    <client_name>{$body/cap:setNextelActiveProduct/channel_act/text()}</client_name>
    <traffic_type>DATOS</traffic_type>
    <imsi>{$body/cap:setNextelActiveProduct/lc_imsi/text()}</imsi>
    <id_pcrf_prod>{$body/cap:setNextelActiveProduct/servicioKidPcrf/text()}</id_pcrf_prod>
    <flagDesactivaExiste>1</flagDesactivaExiste>
	
    <unitFree>{$body/cap:setNextelActiveProduct/file2/text()}</unitFree>
    <cadenaInicioDate>{$StartDateTime}</cadenaInicioDate>
    <cadenaFinDate>{$EndDateTime}</cadenaFinDate>
    <iniciaDate>{$ActualDate}</iniciaDate>
    <finDate>{$TotalDate}</finDate>	
</cap:setNextelActiveProduct>]]></con1:xqueryText>
                                            </con2:expr>
                                        </con2:assign>
                                    </con2:requestTransform>
                                    <con2:responseTransform>
                                        <con2:assign varName="desactivarErrorSrv">
                                            <con1:id>_ActionId-3135677001892557768-780c3176.15361e86124.-78fb</con1:id>
                                            <con2:expr>
                                                <con1:xqueryText>data($desactivaResp/error_code)</con1:xqueryText>
                                            </con2:expr>
                                        </con2:assign>
                                        <con2:assign varName="desactivarErrorDescSrv">
                                            <con1:id>_ActionId-3135677001892557768-780c3176.15361e86124.-7559</con1:id>
                                            <con2:expr>
                                                <con1:xqueryText>data($desactivaResp/err_description)</con1:xqueryText>
                                            </con2:expr>
                                        </con2:assign>
                                        <con2:ifThenElse>
                                            <con1:id>_ActionId-3135677001892557768-780c3176.15361e86124.-7313</con1:id>
                                            <con2:case>
                                                <con2:condition>
                                                    <con1:xqueryText>$desactivarErrorSrv != '0' and $desactivarErrorSrv != 'OK-0001'</con1:xqueryText>
                                                </con2:condition>
                                                <con2:actions>
                                                    <con1:replace varName="body" contents-only="true" xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                                                        <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-3135677001892557768-780c3176.15361e86124.-7312</con5:id>
                                                        <con1:expr>
                                                            <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config"><![CDATA[<cap:setNextelActiveProductResponse xmlns:cap="http://captive.portal.ws.ncl.nii.com">
   <error_code>{$desactivarErrorSrv}</error_code>
   <err_description>{$desactivarErrorDescSrv}</err_description>
</cap:setNextelActiveProductResponse>]]></con5:xqueryText>
                                                        </con1:expr>
                                                    </con1:replace>
                                                    <con4:reply xmlns:con4="http://www.bea.com/wli/sb/stages/config" xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                                                        <con4:id>_ActionId-3135677001892557768-780c3176.15361e86124.-7311</con4:id>
                                                    </con4:reply>
                                                </con2:actions>
                                            </con2:case>
                                            <con2:default/>
                                        </con2:ifThenElse>
                                    </con2:responseTransform>
                                </con2:wsCallout>
                                <con1:ifThenElse xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                                    <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-8851746676683028505-774ffb7a.153971d6aa5.-71cf</con5:id>
                                    <con1:case>
                                        <con1:condition>
                                            <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">$desactivarErrorSrv = '0'</con5:xqueryText>
                                        </con1:condition>
                                        <con1:actions>
                                            <con1:wsCallout>
                                                <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-8851746676683028505-774ffb7a.153971d6aa5.-71c3</con5:id>
                                                <con1:service xsi:type="ref:ProxyRef" ref="PCRF/Proxy Services/PSPcrfService" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                                <con1:operation>subscribeService</con1:operation>
                                                <con1:request>
                                                    <con1:param>
                                                        <con1:name>inPara</con1:name>
                                                        <con1:variable>subscribeServiceReq</con1:variable>
                                                    </con1:param>
                                                </con1:request>
                                                <con1:response>
                                                    <con1:param>
                                                        <con1:name>result</con1:name>
                                                        <con1:variable>subscribeServiceResponse</con1:variable>
                                                    </con1:param>
                                                </con1:response>
                                                <con1:requestTransform>
                                                    <con1:assign varName="subscribeServiceReq">
                                                        <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-8851746676683028505-774ffb7a.153971d6aa5.-71c8</con5:id>
                                                        <con1:expr>
                                                            <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config"><![CDATA[<inPara>
	<subscriber>
	   <!--1 or more repetitions:-->
	   <attribute>
		  <key>USRIDENTIFIER</key>
		  <value>{$body/cap:setNextelActiveProduct/lc_imsi/text()}</value>
	   </attribute>
	</subscriber>
	<!--Zero or more repetitions:-->
	<subscribedService>
	   <!--1 or more repetitions:-->
	   <attribute>
		  <key>SRVNAME</key>
		  <value>{$body/cap:setNextelActiveProduct/servicioKidPcrf/text()}</value>
	   </attribute>
	   <attribute>
		  <key>srvStartDateTime</key>
		  <value>{$StartDateTime}</value>
	   </attribute>
	   <attribute>
		  <key>srvEndDateTime</key>
		  <value>{$EndDateTime}</value>
	   </attribute>
	</subscribedService>
 </inPara>]]></con5:xqueryText>
                                                        </con1:expr>
                                                    </con1:assign>
                                                </con1:requestTransform>
                                                <con1:responseTransform>
                                                    <con1:assign varName="subscribeServResp">
                                                        <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-8851746676683028505-774ffb7a.153971d6aa5.-71c7</con5:id>
                                                        <con1:expr>
                                                            <con4:xqueryText xmlns:con4="http://www.bea.com/wli/sb/stages/config">$subscribeServiceResponse</con4:xqueryText>
                                                        </con1:expr>
                                                    </con1:assign>
                                                    <con1:ifThenElse>
                                                        <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-8851746676683028505-774ffb7a.153971d6aa5.-71c6</con5:id>
                                                        <con1:case>
                                                            <con1:condition>
                                                                <con4:xqueryConditionExpr xmlns:con4="http://www.bea.com/wli/sb/stages/config">
                                                                    <con4:compExpr operator="!=">
                                                                        <con4:leftPath>fn-bea:trim($subscribeServResp/resultCode/text())</con4:leftPath>
                                                                        <con4:rightPath>'0'</con4:rightPath>
                                                                    </con4:compExpr>
                                                                </con4:xqueryConditionExpr>
                                                            </con1:condition>
                                                            <con1:actions>
                                                                <con1:replace varName="body" contents-only="true">
                                                                    <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-8851746676683028505-774ffb7a.153971d6aa5.-71c5</con5:id>
                                                                    <con1:expr>
                                                                        <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config"><![CDATA[<cap:setNextelActiveProductResponse xmlns:cap="http://captive.portal.ws.ncl.nii.com">
   <error_code>{$subscribeServResp/resultCode/text()}</error_code>
   <err_description>{fn:concat('Error al aplicar la bolsa de datos, Key: ',data($subscribeServResp/paras/key),' - Value: ' ,data($subscribeServResp/paras/value))}</err_description>
</cap:setNextelActiveProductResponse>]]></con5:xqueryText>
                                                                    </con1:expr>
                                                                </con1:replace>
                                                                <con4:reply xmlns:con4="http://www.bea.com/wli/sb/stages/config">
                                                                    <con4:id>_ActionId-8851746676683028505-774ffb7a.153971d6aa5.-71c4</con4:id>
                                                                </con4:reply>
                                                            </con1:actions>
                                                        </con1:case>
                                                        <con1:default/>
                                                    </con1:ifThenElse>
                                                </con1:responseTransform>
                                            </con1:wsCallout>
                                        </con1:actions>
                                    </con1:case>
                                    <con1:default/>
                                </con1:ifThenElse>
                                <con2:ifThenElse>
                                    <con1:id>_ActionId-8898132218641135820--41ae47ed.153beee56f5.-7a4c</con1:id>
                                    <con2:case>
                                        <con2:condition>
                                            <con1:xqueryText>xs:boolean($kitSms) = xs:boolean('true')</con1:xqueryText>
                                        </con2:condition>
                                        <con2:actions>
                                            <con2:wsCallout>
                                                <con1:id>_ActionId-8898132218641135820--41ae47ed.153beee56f5.-7a44</con1:id>
                                                <con2:service xsi:type="ref:BusinessServiceRef" ref="PortalCautivo/Business Services/BSRatingEngineManager" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                                <con2:operation>depositDeposit</con2:operation>
                                                <con2:request>
                                                    <con2:body wrapped="false">depositReq</con2:body>
                                                </con2:request>
                                                <con2:response>
                                                    <con2:body wrapped="false">depositResp</con2:body>
                                                </con2:response>
                                                <con2:requestTransform>
                                                    <con2:assign varName="depositReq">
                                                        <con1:id>_ActionId-8898132218641135820--41ae47ed.153beee56f5.-7a4b</con1:id>
                                                        <con2:expr>
                                                            <con1:xqueryText><![CDATA[<rat:depositDeposit xmlns:rat="http://ratingengine.web.api.icc.services.osp.in.alcatel.com">
         <rat:deposit xmlns:xsd="http://web.ratingengine.web.api.icc.services.osp.in.alcatel.com/xsd">
            <xsd:clien_ri>{$clien_ri}</xsd:clien_ri> 
            <xsd:ppm_ri>{$ppm_ri}</xsd:ppm_ri>                
            <xsd:servret>nextelret</xsd:servret>         
            <!--INICIO SMS:-->
            <xsd:usage>SMS_UND_VENTA</xsd:usage>                        
			<xsd:uscost>{data($body/cap:setNextelActiveProduct/file3)}</xsd:uscost>                    
			<xsd:use_act>{$divVigencia}</xsd:use_act>
            <xsd:usqty>{data($body/cap:setNextelActiveProduct/file3)}</xsd:usqty>
		    <!--FIN SMS:-->
            </rat:deposit>
</rat:depositDeposit>]]></con1:xqueryText>
                                                        </con2:expr>
                                                    </con2:assign>
                                                </con2:requestTransform>
                                                <con2:responseTransform>
                                                    <con2:assign varName="valorOutDeposit">
                                                        <con1:id>_ActionId-8898132218641135820--41ae47ed.153beee56f5.-7a4a</con1:id>
                                                        <con2:expr>
                                                            <con1:xqueryText>data($depositResp/ns:return)</con1:xqueryText>
                                                        </con2:expr>
                                                    </con2:assign>
                                                    <con2:assign varName="validaOutDeposit">
                                                        <con1:id>_ActionId-8898132218641135820--41ae47ed.153beee56f5.-7a49</con1:id>
                                                        <con2:expr>
                                                            <con1:xqueryText>contains(xs:string($valorOutDeposit),'Deposit successfull')</con1:xqueryText>
                                                        </con2:expr>
                                                    </con2:assign>
                                                    <con2:ifThenElse>
                                                        <con1:id>_ActionId-8898132218641135820--41ae47ed.153beee56f5.-7a48</con1:id>
                                                        <con2:case>
                                                            <con2:condition>
                                                                <con1:xqueryConditionExpr>
                                                                    <con1:compExpr operator="!=">
                                                                        <con1:leftPath>xs:boolean($planOK)</con1:leftPath>
                                                                        <con1:rightPath>fn:true()</con1:rightPath>
                                                                    </con1:compExpr>
                                                                </con1:xqueryConditionExpr>
                                                            </con2:condition>
                                                            <con2:actions>
                                                                <con1:replace varName="body" contents-only="true" xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                                                                    <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-8898132218641135820--41ae47ed.153beee56f5.-7a46</con5:id>
                                                                    <con1:expr>
                                                                        <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config"><![CDATA[<cap:setNextelActiveProductResponse xmlns:cap="http://captive.portal.ws.ncl.nii.com">
   <error_code>1</error_code>
   <err_description>{concat('Error: en la aplicacion del ajuste bucket Sms Nivel: setAsignaBolsasDeposit')}</err_description>
</cap:setNextelActiveProductResponse>]]></con5:xqueryText>
                                                                    </con1:expr>
                                                                </con1:replace>
                                                                <con4:reply xmlns:con4="http://www.bea.com/wli/sb/stages/config" xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                                                                    <con4:id>_ActionId-8898132218641135820--41ae47ed.153beee56f5.-7a45</con4:id>
                                                                </con4:reply>
                                                            </con2:actions>
                                                        </con2:case>
                                                        <con2:default/>
                                                    </con2:ifThenElse>
                                                </con2:responseTransform>
                                            </con2:wsCallout>
                                        </con2:actions>
                                    </con2:case>
                                    <con2:default/>
                                </con2:ifThenElse>
                                <con2:ifThenElse>
                                    <con1:id>_ActionId-8898132218641135820--41ae47ed.153beee56f5.-7b1b</con1:id>
                                    <con2:case>
                                        <con2:condition>
                                            <con1:xqueryText>xs:boolean($kitVoz) = xs:boolean('true')</con1:xqueryText>
                                        </con2:condition>
                                        <con2:actions>
                                            <con2:wsCallout>
                                                <con1:id>_ActionId-8898132218641135820--41ae47ed.153beee56f5.-7b13</con1:id>
                                                <con2:service xsi:type="ref:BusinessServiceRef" ref="PortalCautivo/Business Services/BSRatingEngineManager" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                                <con2:operation>depositDeposit</con2:operation>
                                                <con2:request>
                                                    <con2:body wrapped="false">depositReq</con2:body>
                                                </con2:request>
                                                <con2:response>
                                                    <con2:body wrapped="false">depositResp</con2:body>
                                                </con2:response>
                                                <con2:requestTransform>
                                                    <con2:assign varName="depositReq">
                                                        <con1:id>_ActionId-8898132218641135820--41ae47ed.153beee56f5.-7b1a</con1:id>
                                                        <con2:expr>
                                                            <con1:xqueryText><![CDATA[<rat:depositDeposit xmlns:rat="http://ratingengine.web.api.icc.services.osp.in.alcatel.com">
         <rat:deposit xmlns:xsd="http://web.ratingengine.web.api.icc.services.osp.in.alcatel.com/xsd">
            <xsd:clien_ri>{$clien_ri}</xsd:clien_ri> 
            <xsd:ppm_ri>{$ppm_ri}</xsd:ppm_ri>                
            <xsd:servret>nextelret</xsd:servret>         
            <!--INICIO VOZ:-->
            <xsd:usage>VOZ_VOL_VENTA</xsd:usage>                        
            <xsd:uscost>{data($body/cap:setNextelActiveProduct/unit_free)}</xsd:uscost>                      
            <xsd:use_act>{$divVigencia}</xsd:use_act>                   
            <xsd:usqty>{data($body/cap:setNextelActiveProduct/unit_free)}</xsd:usqty> 
            <!--FIN VOZ:-->
            </rat:deposit>
</rat:depositDeposit>]]></con1:xqueryText>
                                                        </con2:expr>
                                                    </con2:assign>
                                                </con2:requestTransform>
                                                <con2:responseTransform>
                                                    <con2:assign varName="valorOutDeposit">
                                                        <con1:id>_ActionId-8898132218641135820--41ae47ed.153beee56f5.-7b19</con1:id>
                                                        <con2:expr>
                                                            <con1:xqueryText>data($depositResp/ns:return)</con1:xqueryText>
                                                        </con2:expr>
                                                    </con2:assign>
                                                    <con2:assign varName="validaOutDeposit">
                                                        <con1:id>_ActionId-8898132218641135820--41ae47ed.153beee56f5.-7b18</con1:id>
                                                        <con2:expr>
                                                            <con1:xqueryText>contains(xs:string($valorOutDeposit),'Deposit successfull')</con1:xqueryText>
                                                        </con2:expr>
                                                    </con2:assign>
                                                    <con2:ifThenElse>
                                                        <con1:id>_ActionId-8898132218641135820--41ae47ed.153beee56f5.-7b17</con1:id>
                                                        <con2:case>
                                                            <con2:condition>
                                                                <con1:xqueryConditionExpr>
                                                                    <con1:compExpr operator="!=">
                                                                        <con1:leftPath>xs:boolean($planOK)</con1:leftPath>
                                                                        <con1:rightPath>fn:true()</con1:rightPath>
                                                                    </con1:compExpr>
                                                                </con1:xqueryConditionExpr>
                                                            </con2:condition>
                                                            <con2:actions>
                                                                <con1:replace varName="body" contents-only="true" xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                                                                    <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-8898132218641135820--41ae47ed.153beee56f5.-7b15</con5:id>
                                                                    <con1:expr>
                                                                        <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config"><![CDATA[<cap:setNextelActiveProductResponse xmlns:cap="http://captive.portal.ws.ncl.nii.com">
   <error_code>1</error_code>
   <err_description>{concat('Error: en la aplicacion del ajuste bucket Voz Nivel: setAsignaBolsasDeposit')}</err_description>
</cap:setNextelActiveProductResponse>]]></con5:xqueryText>
                                                                    </con1:expr>
                                                                </con1:replace>
                                                                <con4:reply xmlns:con4="http://www.bea.com/wli/sb/stages/config" xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                                                                    <con4:id>_ActionId-8898132218641135820--41ae47ed.153beee56f5.-7b14</con4:id>
                                                                </con4:reply>
                                                            </con2:actions>
                                                        </con2:case>
                                                        <con2:default/>
                                                    </con2:ifThenElse>
                                                </con2:responseTransform>
                                            </con2:wsCallout>
                                        </con2:actions>
                                    </con2:case>
                                    <con2:default/>
                                </con2:ifThenElse>
                            </con2:actions>
                        </con2:case>
                        <con2:default>
                            <con2:assign varName="trafixTypeVenta">
                                <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-6476</con1:id>
                                <con2:expr>
                                    <con1:xqueryText>if($trafixType = 'DATOS') then
	('DATOS_VOL_VENTA')
	else(
		if($trafixType = 'VOZ') then
		('VOZ_VOL_VENTA')
		else(
			if($trafixType = 'SMS') then
			('SMS_UND_VENTA')
			else
				(
				 'ErrorTipo'
				)
)
)</con1:xqueryText>
                                </con2:expr>
                            </con2:assign>
                            <con2:ifThenElse>
                                <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-6343</con1:id>
                                <con2:case>
                                    <con2:condition>
                                        <con1:xqueryConditionExpr>
                                            <con1:compExpr operator="=">
                                                <con1:leftPath>'ErrorTipo'</con1:leftPath>
                                                <con1:rightPath>xs:string($trafixTypeVenta)</con1:rightPath>
                                            </con1:compExpr>
                                        </con1:xqueryConditionExpr>
                                    </con2:condition>
                                    <con2:actions>
                                        <con2:Error>
                                            <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-630b</con1:id>
                                            <con2:errCode>1</con2:errCode>
                                            <con2:message>No se encuentra bucket para el tipo de trafico del producto</con2:message>
                                        </con2:Error>
                                    </con2:actions>
                                </con2:case>
                                <con2:default/>
                            </con2:ifThenElse>
                            <con2:wsCallout>
                                <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-6263</con1:id>
                                <con2:service xsi:type="ref:BusinessServiceRef" ref="PortalCautivo/Business Services/BSRatingEngineManager" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                <con2:operation>depositDeposit</con2:operation>
                                <con2:request>
                                    <con2:body wrapped="false">depositReq</con2:body>
                                </con2:request>
                                <con2:response>
                                    <con2:body wrapped="false">depositResp</con2:body>
                                </con2:response>
                                <con2:requestTransform>
                                    <con2:assign varName="depositReq">
                                        <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-6264</con1:id>
                                        <con2:expr>
                                            <con1:xqueryText><![CDATA[<rat:depositDeposit xmlns:rat="http://ratingengine.web.api.icc.services.osp.in.alcatel.com">
    <!--Optional:-->
    <rat:deposit xmlns:xsd="http://web.ratingengine.web.api.icc.services.osp.in.alcatel.com/xsd">
            <xsd:clien_ri>{$clien_ri}</xsd:clien_ri> 
            <!--Optional:-->
            <xsd:ppm_ri>{$ppm_ri}</xsd:ppm_ri>                
            <!--Optional:-->
            <xsd:servret>nextelret</xsd:servret>                
            <!--Zero or more repetitions:-->
            <xsd:usage>{$trafixTypeVenta}</xsd:usage>                        
            <!--Optional:-->
            <xsd:uscost>{data($body/cap:setNextelActiveProduct/unit_free)}</xsd:uscost>                      
            <!--Zero or more repetitions:-->
            <xsd:use_act>{$divVigencia}</xsd:use_act>                   
            <!--Zero or more repetitions:-->
            <xsd:usqty>{data($body/cap:setNextelActiveProduct/unit_free)}</xsd:usqty> 
            </rat:deposit>
</rat:depositDeposit>]]></con1:xqueryText>
                                        </con2:expr>
                                    </con2:assign>
                                </con2:requestTransform>
                                <con2:responseTransform>
                                    <con2:assign varName="valorOutDeposit">
                                        <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-6107</con1:id>
                                        <con2:expr>
                                            <con1:xqueryText>data($depositResp/ns:return)</con1:xqueryText>
                                        </con2:expr>
                                    </con2:assign>
                                    <con2:assign varName="validaOutDeposit">
                                        <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-60c4</con1:id>
                                        <con2:expr>
                                            <con1:xqueryText>contains(xs:string($valorOutDeposit),'Deposit successfull')</con1:xqueryText>
                                        </con2:expr>
                                    </con2:assign>
                                    <con2:ifThenElse>
                                        <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-60c7</con1:id>
                                        <con2:case>
                                            <con2:condition>
                                                <con1:xqueryConditionExpr>
                                                    <con1:compExpr operator="!=">
                                                        <con1:leftPath>xs:boolean($planOK)</con1:leftPath>
                                                        <con1:rightPath>fn:true()</con1:rightPath>
                                                    </con1:compExpr>
                                                </con1:xqueryConditionExpr>
                                            </con2:condition>
                                            <con2:actions>
                                                <con1:replace varName="body" contents-only="true" xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                                                    <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-6030</con5:id>
                                                    <con1:expr>
                                                        <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config"><![CDATA[<cap:setNextelActiveProductResponse xmlns:cap="http://captive.portal.ws.ncl.nii.com">
   <error_code>1</error_code>
   <err_description>{concat('Error: en la aplicacion del ajuste bucket Nivel: setAsignaBolsasDeposit')}</err_description>
</cap:setNextelActiveProductResponse>]]></con5:xqueryText>
                                                    </con1:expr>
                                                </con1:replace>
                                                <con4:reply xmlns:con4="http://www.bea.com/wli/sb/stages/config" xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                                                    <con4:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-602e</con4:id>
                                                </con4:reply>
                                            </con2:actions>
                                        </con2:case>
                                        <con2:default/>
                                    </con2:ifThenElse>
                                </con2:responseTransform>
                            </con2:wsCallout>
                        </con2:default>
                    </con2:ifThenElse>
                </con:actions>
            </con:stage>
            <con:stage name="setAjusteICC">
                <con:context>
                    <con1:varNsDecl namespace="http://captive.portal.ws.ncl.nii.com" prefix="cap"/>
                </con:context>
                <con:actions>
                    <con2:ifThenElse>
                        <con1:id>_ActionId-3602376958848697374--7242e8b0.15d08bfc312.-7f6f</con1:id>
                        <con2:case>
                            <con2:condition>
                                <con1:xqueryText>$body/cap:setNextelActiveProduct/metodo_pago/text() = 'CONTRA_FACTURA'</con1:xqueryText>
                            </con2:condition>
                            <con2:actions>
                                <con2:wsCallout>
                                    <con1:id>_ActionId-3602376958848697374--7242e8b0.15d08bfc312.-7f24</con1:id>
                                    <con2:service ref="PortalCautivo/Proxy Services/LCPSConsultaYCreaOCC" xsi:type="con:PipelineRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                    <con2:operation>setNextelActiveProduct</con2:operation>
                                    <con2:request>
                                        <con2:body>consultaCreaOCC</con2:body>
                                    </con2:request>
                                    <con2:response>
                                        <con2:body>consultaCreaOCCResponse</con2:body>
                                    </con2:response>
                                    <con2:requestTransform>
                                        <con2:assign varName="consultaCreaOCC">
                                            <con1:id>_ActionId-3602376958848697374--7242e8b0.15d08bfc312.-7f03</con1:id>
                                            <con2:expr>
                                                <con1:xqueryText><![CDATA[<cap:setNextelActiveProduct xmlns:cap="http://captive.portal.ws.ncl.nii.com">
    <lc_customer>{data($body/cap:setNextelActiveProduct/lc_customer)}</lc_customer>
    <tariff_prod>{data($body/cap:setNextelActiveProduct/tariff_prod)}</tariff_prod>
    <traffic_type>{data($body/cap:setNextelActiveProduct/file1)}</traffic_type>
    <sn_code>{data($body/cap:setNextelActiveProduct/id_pcrf_prod)}</sn_code>
    <contractId>{data($body/cap:setNextelActiveProduct/lc_contractId)}</contractId>
    <lc_tmcode>{data($body/cap:setNextelActiveProduct/rate_plan)}</lc_tmcode>
	<fechaActivacion>{$fechaOCC}</fechaActivacion>
</cap:setNextelActiveProduct>]]></con1:xqueryText>
                                            </con2:expr>
                                        </con2:assign>
                                    </con2:requestTransform>
                                    <con2:responseTransform>
                                        <con2:assign varName="consultaCreaOCCResp">
                                            <con1:id>_ActionId-3602376958848697374--7242e8b0.15d08bfc312.-7eda</con1:id>
                                            <con2:expr>
                                                <con1:xqueryText>$consultaCreaOCCResponse</con1:xqueryText>
                                            </con2:expr>
                                        </con2:assign>
                                        <con2:assign varName="LCErrorOCC">
                                            <con1:id>_ActionId-3602376958848697374--7242e8b0.15d08bfc312.-7ebf</con1:id>
                                            <con2:expr>
                                                <con1:xqueryText>data($consultaCreaOCCResp/error_code)</con1:xqueryText>
                                            </con2:expr>
                                        </con2:assign>
                                        <con2:ifThenElse>
                                            <con1:id>_ActionId-3602376958848697374--7242e8b0.15d08bfc312.-7ea0</con1:id>
                                            <con2:case>
                                                <con2:condition>
                                                    <con1:xqueryConditionExpr>
                                                        <con1:compExpr operator="!=">
                                                            <con1:leftPath>$LCErrorOCC</con1:leftPath>
                                                            <con1:rightPath>'0'</con1:rightPath>
                                                        </con1:compExpr>
                                                    </con1:xqueryConditionExpr>
                                                </con2:condition>
                                                <con2:actions>
                                                    <con2:replace varName="body" contents-only="true">
                                                        <con1:id>_ActionId-3602376958848697374--7242e8b0.15d08bfc312.-7e63</con1:id>
                                                        <con2:expr>
                                                            <con1:xqueryText><![CDATA[<cap:setNextelActiveProductResponse xmlns:cap="http://captive.portal.ws.ncl.nii.com">
 <error_code>{$LCErrorOCC}</error_code>
 <err_description>{data($consultaCreaOCCResp/err_description)}</err_description>
</cap:setNextelActiveProductResponse>]]></con1:xqueryText>
                                                        </con2:expr>
                                                    </con2:replace>
                                                    <con1:reply>
                                                        <con1:id>_ActionId-3602376958848697374--7242e8b0.15d08bfc312.-7e40</con1:id>
                                                    </con1:reply>
                                                </con2:actions>
                                            </con2:case>
                                            <con2:default/>
                                        </con2:ifThenElse>
                                    </con2:responseTransform>
                                </con2:wsCallout>
                            </con2:actions>
                        </con2:case>
                        <con2:default>
                            <con2:wsCallout>
                                <con1:id>_ActionId-3602376958848697374--7242e8b0.15d08bfc312.-7f5f</con1:id>
                                <con2:service xsi:type="ref:ProxyRef" ref="PortalCautivo/Proxy Services/PSAjustaICCPortal" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                <con2:operation>setAjustaICCPortal</con2:operation>
                                <con2:request>
                                    <con2:body>ajusteICCReq</con2:body>
                                </con2:request>
                                <con2:response>
                                    <con2:body>ajusteICCResp</con2:body>
                                </con2:response>
                                <con2:requestTransform>
                                    <con2:assign varName="ajusteICCReq">
                                        <con1:id>_ActionId-3602376958848697374--7242e8b0.15d08bfc312.-7f66</con1:id>
                                        <con2:expr>
                                            <con1:xqueryText><![CDATA[<cap:setAjustaICCPortal xmlns:cap="http://captive.portal.ws.ncl.nii.com">
    <phone_number>{data($body/cap:setNextelActiveProduct/phone_number)}</phone_number>
    <tariff_prod>{data($body/cap:setNextelActiveProduct/tariff_prod)}</tariff_prod>
</cap:setAjustaICCPortal>]]></con1:xqueryText>
                                        </con2:expr>
                                    </con2:assign>
                                </con2:requestTransform>
                                <con2:responseTransform>
                                    <con1:assign varName="LCErrorOCC" xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                                        <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-3602376958848697374--7242e8b0.15d08bfc312.-7f65</con5:id>
                                        <con1:expr>
                                            <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">data($ajusteICCResp/error_code)</con5:xqueryText>
                                        </con1:expr>
                                    </con1:assign>
                                    <con1:assign varName="cadenaBucket" xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                                        <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-3602376958848697374--7242e8b0.15d08bfc312.-7f64</con5:id>
                                        <con1:expr>
                                            <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config">data($ajusteICCResp/cadenaBucket)</con5:xqueryText>
                                        </con1:expr>
                                    </con1:assign>
                                    <con1:ifThenElse xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                                        <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-3602376958848697374--7242e8b0.15d08bfc312.-7f63</con5:id>
                                        <con1:case>
                                            <con1:condition>
                                                <con4:xqueryConditionExpr xmlns:con4="http://www.bea.com/wli/sb/stages/config">
                                                    <con4:compExpr operator="!=">
                                                        <con4:leftPath>$LCErrorOCC</con4:leftPath>
                                                        <con4:rightPath>'0'</con4:rightPath>
                                                    </con4:compExpr>
                                                </con4:xqueryConditionExpr>
                                            </con1:condition>
                                            <con1:actions>
                                                <con1:replace varName="body" contents-only="true">
                                                    <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-3602376958848697374--7242e8b0.15d08bfc312.-7f61</con5:id>
                                                    <con1:expr>
                                                        <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config"><![CDATA[<cap:setNextelActiveProductResponse xmlns:cap="http://captive.portal.ws.ncl.nii.com">
   <error_code>{$LCErrorOCC}</error_code>
   <err_description>{concat('Error: ',data($ajusteICCResp/err_description),', Nivel: AjusteICC')}</err_description>
</cap:setNextelActiveProductResponse>]]></con5:xqueryText>
                                                    </con1:expr>
                                                </con1:replace>
                                                <con4:reply xmlns:con4="http://www.bea.com/wli/sb/stages/config">
                                                    <con4:id>_ActionId-3602376958848697374--7242e8b0.15d08bfc312.-7f60</con4:id>
                                                </con4:reply>
                                            </con1:actions>
                                        </con1:case>
                                        <con1:default/>
                                    </con1:ifThenElse>
                                </con2:responseTransform>
                            </con2:wsCallout>
                        </con2:default>
                    </con2:ifThenElse>
                </con:actions>
            </con:stage>
            <con:stage name="setAplicaPromocion">
                <con:context>
                    <con1:varNsDecl namespace="http://captive.portal.ws.ncl.nii.com" prefix="cap"/>
                </con:context>
                <con:actions>
                    <con2:wsCallout>
                        <con1:id>_ActionId-3811420300521301181--5fc27fb8.154ed48b70d.-7f93</con1:id>
                        <con2:service xsi:type="ref:ProxyRef" ref="BenePro/Proxy Services/PSRecv" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                        <con2:operation>aplicarPromocion</con2:operation>
                        <con2:request>
                            <con2:body>aplicaPromocionReq</con2:body>
                        </con2:request>
                        <con2:response>
                            <con2:body>aplicaPromocionResp</con2:body>
                        </con2:response>
                        <con2:requestTransform>
                            <con2:replace varName="aplicaPromocionReq">
                                <con1:id>_ActionId-3811420300521301181--5fc27fb8.154ed48b70d.-7f5b</con1:id>
                                <con2:expr>
                                    <con1:xqueryTransform>
                                        <con1:resource ref="PortalCautivo/Resources/XQuery/IN_XQ_BenePro_AplicaPromociones"/>
                                        <con1:param name="segment_prod">
                                            <con1:path>normalize-space($body/cap:setNextelActiveProduct/segment_prod/text())</con1:path>
                                        </con1:param>
                                        <con1:param name="id_pcrf_prod">
                                            <con1:path>normalize-space($body/cap:setNextelActiveProduct/id_pcrf_prod/text())</con1:path>
                                        </con1:param>
                                        <con1:param name="traffic_type">
                                            <con1:path>normalize-space($body/cap:setNextelActiveProduct/traffic_type/text())</con1:path>
                                        </con1:param>
                                        <con1:param name="type_prod_bscs">
                                            <con1:path>normalize-space($body/cap:setNextelActiveProduct/type_prod_bscs/text())</con1:path>
                                        </con1:param>
                                        <con1:param name="tariff_prod">
                                            <con1:path>normalize-space($body/cap:setNextelActiveProduct/tariff_prod/text())</con1:path>
                                        </con1:param>
                                        <con1:param name="vigencia">
                                            <con1:path>normalize-space($body/cap:setNextelActiveProduct/vigencia/text())</con1:path>
                                        </con1:param>
                                        <con1:param name="channel_act">
                                            <con1:path>normalize-space($body/cap:setNextelActiveProduct/channel_act/text())</con1:path>
                                        </con1:param>
                                        <con1:param name="id_prod">
                                            <con1:path>normalize-space($body/cap:setNextelActiveProduct/id_prod/text())</con1:path>
                                        </con1:param>
                                        <con1:param name="rate_plan">
                                            <con1:path>normalize-space($body/cap:setNextelActiveProduct/rate_plan/text())</con1:path>
                                        </con1:param>
                                        <con1:param name="phone_number">
                                            <con1:path>normalize-space($body/cap:setNextelActiveProduct/phone_number/text())</con1:path>
                                        </con1:param>
                                        <con1:param name="cod_plan">
                                            <con1:path>normalize-space($body/cap:setNextelActiveProduct/codPlan/text())</con1:path>
                                        </con1:param>
                                    </con1:xqueryTransform>
                                </con2:expr>
                            </con2:replace>
                        </con2:requestTransform>
                        <con2:responseTransform>
                            <con2:assign varName="codigoPromo">
                                <con1:id>_ActionId-3811420300521301181--5fc27fb8.154ed48b70d.-7eeb</con1:id>
                                <con2:expr>
                                    <con1:xqueryText>$aplicaPromocionResp/return/codigo/text()</con1:xqueryText>
                                </con2:expr>
                            </con2:assign>
                            <con2:assign varName="codNullReplace">
                                <con1:id>_ActionId-3811420300521301181--5fc27fb8.154ed48b70d.-7ece</con1:id>
                                <con2:expr>
                                    <con1:xqueryText>if(empty($codigoPromo)) then (
$aplicaPromocionResp/return/descripcion/text()
) else
($codigoPromo)</con1:xqueryText>
                                </con2:expr>
                            </con2:assign>
                        </con2:responseTransform>
                    </con2:wsCallout>
                </con:actions>
            </con:stage>
            <con:stage name="registraVenta">
                <con:context>
                    <con1:userNsDecl namespace="http://xmlns.oracle.com/pcbpel/adapter/db/PROVI_BOLS/NII_BSCS_PORTAL_CAUTIVO_PKG/REGISTRA_ALTA_PRODUCTOS_PRC/" prefix="al"/>
                    <con1:userNsDecl namespace="http://xmlns.oracle.com/pcbpel/adapter/db/validaTransaccioDBA" prefix="val"/>
                    <con1:varNsDecl namespace="http://captive.portal.ws.ncl.nii.com" prefix="cap"/>
                </con:context>
                <con:actions>
                    <con2:wsCallout>
                        <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-7090</con1:id>
                        <con2:service xsi:type="ref:BusinessServiceRef" ref="PortalCautivo/Business Services/BSRegistraAltaProductosDBA" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                        <con2:operation>RegistraAltaProductosDBA</con2:operation>
                        <con2:request>
                            <con2:body>RegistraAltaProd</con2:body>
                        </con2:request>
                        <con2:response>
                            <con2:body>RegistraAltaProdResponse</con2:body>
                        </con2:response>
                        <con2:requestTransform>
                            <con2:assign varName="RegistraAltaProd">
                                <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-7098</con1:id>
                                <con2:expr>
                                    <con1:xqueryText><![CDATA[<reg:InputParameters xmlns:reg="http://xmlns.oracle.com/pcbpel/adapter/db/PROVI_BOLS/NII_BSCS_PORTAL_CAUTIVO_PKG/REGISTRA_ALTA_PRODUCTOS_PRC/">
    <reg:P_IMSI>{data($body/cap:setNextelActiveProduct/lc_imsi)}</reg:P_IMSI>
    <reg:P_PHONE_NUMBER>{data($body/cap:setNextelActiveProduct/phone_number)}</reg:P_PHONE_NUMBER>
    <reg:P_CUSTOMER_ID>{data($body/cap:setNextelActiveProduct/lc_customer)}</reg:P_CUSTOMER_ID>
    <reg:P_ID_PROD>{data($body/cap:setNextelActiveProduct/id_prod)}</reg:P_ID_PROD>
    <reg:P_ID_PCRF_PROD>{data($body/cap:setNextelActiveProduct/id_pcrf_prod)}</reg:P_ID_PCRF_PROD>
    <reg:P_ID_BSCS_PROD>{data($body/cap:setNextelActiveProduct/id_bscs_prod)}</reg:P_ID_BSCS_PROD>
    <reg:P_CLIENT_NAME>{data($body/cap:setNextelActiveProduct/channel_act)}</reg:P_CLIENT_NAME>
    <reg:P_DATE_BUY>{data(fn:concat(fn-bea:date-to-string-with-format("MM-dd-yyyy",xs:date($LCActualFecha))," ",fn-bea:time-to-string-with-format("HH:mm:ss", xs:time($LCActualHora))))}</reg:P_DATE_BUY>
    <reg:P_ESTADO_ASIGNADO>{$cadenaBucket}</reg:P_ESTADO_ASIGNADO>
    <reg:P_METODO_PAGO>{data($body/cap:setNextelActiveProduct/metodo_pago)}</reg:P_METODO_PAGO>
    <reg:P_FECHA_EXPIRACION>{fn:concat(fn-bea:date-to-string-with-format("MM-dd-yyyy",xs:date($LCFecha))," ",fn-bea:time-to-string-with-format("HH:mm:ss",xs:time($LCHora)))}</reg:P_FECHA_EXPIRACION>
    <reg:PV_PLAN>{$body/cap:setNextelActiveProduct/rate_plan/text()}</reg:PV_PLAN>
    <reg:PV_TICKET_PROMO>{$codNullReplace}</reg:PV_TICKET_PROMO>
    <reg:PV_FILE_1></reg:PV_FILE_1>
    <reg:PV_FILE_2></reg:PV_FILE_2>
    <reg:PV_FILE_3></reg:PV_FILE_3>
</reg:InputParameters>]]></con1:xqueryText>
                                </con2:expr>
                            </con2:assign>
                        </con2:requestTransform>
                        <con2:responseTransform>
                            <con2:assign varName="LC_SN_COD_RETORNO">
                                <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-7096</con1:id>
                                <con2:expr>
                                    <con1:xqueryText>data($RegistraAltaProdResponse/al:SN_COD_RETORNO)</con1:xqueryText>
                                </con2:expr>
                            </con2:assign>
                            <con2:assign varName="LC_SQ_TRANSACTION_CODE_BUY">
                                <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-7095</con1:id>
                                <con2:expr>
                                    <con1:xqueryText>data($RegistraAltaProdResponse/al:SV_SQ_TRANSACTION_CODE_BUY)</con1:xqueryText>
                                </con2:expr>
                            </con2:assign>
                            <con1:ifThenElse xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                                <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-7094</con5:id>
                                <con1:case>
                                    <con1:condition>
                                        <con4:xqueryConditionExpr xmlns:con4="http://www.bea.com/wli/sb/stages/config">
                                            <con4:boolExpr operator="or">
                                                <con4:compExpr operator="!=">
                                                    <con4:leftPath>data($LC_SN_COD_RETORNO)</con4:leftPath>
                                                    <con4:rightPath>'0'</con4:rightPath>
                                                </con4:compExpr>
                                                <con4:compExpr operator="=">
                                                    <con4:leftPath>data($LC_SQ_TRANSACTION_CODE_BUY)</con4:leftPath>
                                                    <con4:rightPath>'1'</con4:rightPath>
                                                </con4:compExpr>
                                            </con4:boolExpr>
                                        </con4:xqueryConditionExpr>
                                    </con1:condition>
                                    <con1:actions>
                                        <con1:replace varName="body" contents-only="true">
                                            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-7092</con5:id>
                                            <con1:expr>
                                                <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config"><![CDATA[<cap:setNextelActiveProductResponse xmlns:cap="http://captive.portal.ws.ncl.nii.com">
 <transaction_code></transaction_code>
 <error_code>{$LC_SN_COD_RETORNO}</error_code>
 <err_description>{data($RegistraAltaProdResp/al:SV_MENS_RETORNO)}</err_description>
</cap:setNextelActiveProductResponse>]]></con5:xqueryText>
                                            </con1:expr>
                                        </con1:replace>
                                        <con4:reply xmlns:con4="http://www.bea.com/wli/sb/stages/config">
                                            <con4:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-7091</con4:id>
                                        </con4:reply>
                                    </con1:actions>
                                </con1:case>
                                <con1:default/>
                            </con1:ifThenElse>
                        </con2:responseTransform>
                    </con2:wsCallout>
                    <con2:wsCallout>
                        <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-70a2</con1:id>
                        <con2:service xsi:type="ref:BusinessServiceRef" ref="PortalCautivo/Business Services/BSValidaTransaccioDBA" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                        <con2:operation>validaTransaccioDBA</con2:operation>
                        <con2:request>
                            <con2:body>validaTransaccioDBA</con2:body>
                        </con2:request>
                        <con2:response>
                            <con2:body>validaTransaccioDBAResponse</con2:body>
                        </con2:response>
                        <con2:requestTransform>
                            <con2:assign varName="validaTransaccioDBA">
                                <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-70a9</con1:id>
                                <con2:expr>
                                    <con1:xqueryText>&lt;val:validaTransaccioDBAInput xmlns:val="http://xmlns.oracle.com/pcbpel/adapter/db/validaTransaccioDBA">
    &lt;val:transaction_code>{$LC_SQ_TRANSACTION_CODE_BUY}&lt;/val:transaction_code>
&lt;/val:validaTransaccioDBAInput></con1:xqueryText>
                                </con2:expr>
                            </con2:assign>
                        </con2:requestTransform>
                        <con2:responseTransform>
                            <con2:assign varName="LCValCount">
                                <con1:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-70a7</con1:id>
                                <con2:expr>
                                    <con1:xqueryText>data($validaTransaccioDBAResponse/val:valCount)</con1:xqueryText>
                                </con2:expr>
                            </con2:assign>
                            <con1:ifThenElse xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                                <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-70a6</con5:id>
                                <con1:case>
                                    <con1:condition>
                                        <con4:xqueryConditionExpr xmlns:con4="http://www.bea.com/wli/sb/stages/config">
                                            <con4:compExpr operator="=">
                                                <con4:leftPath>$LCValCount</con4:leftPath>
                                                <con4:rightPath>'0'</con4:rightPath>
                                            </con4:compExpr>
                                        </con4:xqueryConditionExpr>
                                    </con1:condition>
                                    <con1:actions>
                                        <con1:Error>
                                            <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-5255164703822402466--3fa390e8.161664a3d7f.-6d20</con5:id>
                                            <con1:errCode>0</con1:errCode>
                                            <con1:message>La ejecucion se realizo pero no se registro la transaccion.</con1:message>
                                        </con1:Error>
                                    </con1:actions>
                                </con1:case>
                                <con1:default/>
                            </con1:ifThenElse>
                        </con2:responseTransform>
                    </con2:wsCallout>
                </con:actions>
            </con:stage>
            <con:stage name="getMensajeSmsProducto">
                <con:context>
                    <con1:varNsDecl namespace="http://captive.portal.ws.ncl.nii.com" prefix="cap"/>
                </con:context>
                <con:actions>
                    <con2:wsCallout>
                        <con1:id>_ActionId-675937645564541483--6d07faf1.14e4f144ff2.-7bf4</con1:id>
                        <con2:service xsi:type="ref:BusinessServiceRef" ref="PortalCautivo/Business Services/BSServiceGetMensajeSmsProducto" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                        <con2:operation>getMensajeSmsProducto</con2:operation>
                        <con2:request>
                            <con2:body>getMensajeSmsProdReq</con2:body>
                        </con2:request>
                        <con2:response>
                            <con2:body>getMensajeSmsProdResp</con2:body>
                        </con2:response>
                        <con2:requestTransform>
                            <con2:assign varName="getMensajeSmsProdReq">
                                <con1:id>_ActionId-675937645564541483--6d07faf1.14e4f144ff2.-7b85</con1:id>
                                <con2:expr>
                                    <con1:xqueryTransform>
                                        <con1:resource ref="PortalCautivo/Resources/XQuery/IN_XQ_getMensajeSmsProduct"/>
                                        <con1:param name="id_prod">
                                            <con1:path>data($body/cap:setNextelActiveProduct/id_prod)</con1:path>
                                        </con1:param>
                                        <con1:param name="id_prod_pcrf">
                                            <con1:path>data($body/cap:setNextelActiveProduct/id_pcrf_prod)</con1:path>
                                        </con1:param>
                                    </con1:xqueryTransform>
                                </con2:expr>
                            </con2:assign>
                        </con2:requestTransform>
                        <con2:responseTransform/>
                    </con2:wsCallout>
                </con:actions>
            </con:stage>
            <con:stage name="ResetHLRpatch">
                <con:context>
                    <con1:userNsDecl namespace="http://xmlns.oracle.com/pcbpel/adapter/db/getPlataformaXPlanDba" prefix="pln"/>
                    <con1:varNsDecl namespace="http://captive.portal.ws.ncl.nii.com" prefix="cap"/>
                </con:context>
                <con:actions>
                    <con2:assign varName="isRefresh">
                        <con1:id>_ActionId-8511316891119908473--69675f1b.1633bbd8e1a.-797b</con1:id>
                        <con2:expr>
                            <con1:xqueryText>if($body/cap:setNextelActiveProduct/segment_prod/text() = 'PREPAID') then
(
  if($body/cap:setNextelActiveProduct/traffic_type/text() = 'DATOS') then
  ('S')
  else(
    if($body/cap:setNextelActiveProduct/type_prod_bscs/text() = 'BOL_MIX' and empty($body/cap:setNextelActiveProduct/servicioKidPcrf/text())) then
    ('S')
    else('N')
  )
)else('N')</con1:xqueryText>
                        </con2:expr>
                    </con2:assign>
                    <con2:ifThenElse>
                        <con1:id>_ActionId-2208303940806224848--562d5b31.1559da32cb3.-7f93</con1:id>
                        <con2:case>
                            <con2:condition>
                                <con1:xqueryText>$isRefresh = 'S'</con1:xqueryText>
                            </con2:condition>
                            <con2:actions>
                                <con4:route>
                                    <con1:id>_ActionId-8511316891119908473--69675f1b.1633bbd8e1a.-78d6</con1:id>
                                    <con4:service ref="HLRpatch/Proyx Services/PSHLRpatch" xsi:type="ref:ProxyRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                                    <con4:operation>sendResetAPN</con4:operation>
                                    <con4:outboundTransform>
                                        <con2:routing-options>
                                            <con1:id>_ActionId-8575695815343403766--6bc32b7e.16388b40ebc.-7ea5</con1:id>
                                            <con2:mode>request</con2:mode>
                                            <con2:qualityOfService>best-effort</con2:qualityOfService>
                                            <con2:retryCount>0</con2:retryCount>
                                        </con2:routing-options>
                                        <con2:replace varName="body" contents-only="true">
                                            <con1:id>_ActionId-8511316891119908473--69675f1b.1633bbd8e1a.-76c3</con1:id>
                                            <con2:expr>
                                                <con1:xqueryTransform>
                                                    <con1:resource ref="PortalCautivo/Resources/XQuery/IN_XQ_ResetHLRpatch"/>
                                                    <con1:param name="imsi1">
                                                        <con1:path>$body/cap:setNextelActiveProduct/lc_imsi/text()</con1:path>
                                                    </con1:param>
                                                    <con1:param name="idPlan1">
                                                        <con1:path>$body/cap:setNextelActiveProduct/rate_plan/text()</con1:path>
                                                    </con1:param>
                                                </con1:xqueryTransform>
                                            </con2:expr>
                                        </con2:replace>
                                    </con4:outboundTransform>
                                </con4:route>
                            </con2:actions>
                        </con2:case>
                    </con2:ifThenElse>
                </con:actions>
            </con:stage>
            <con:stage name="sendSMSSiebelRqRsPS">
                <con:context>
                    <con1:varNsDecl namespace="http://captive.portal.ws.ncl.nii.com" prefix="cap"/>
                </con:context>
                <con:actions>
                    <con4:route>
                        <con1:id>_ActionId-8511316891119908473--69675f1b.1633bbd8e1a.-7620</con1:id>
                        <con4:service ref="PortalCautivo/Business Services/BSServiceSendSMSSiebelRqRs" xsi:type="ref:BusinessServiceRef" xmlns:ref="http://www.bea.com/wli/sb/reference"/>
                        <con4:operation>sendSMS</con4:operation>
                        <con4:outboundTransform>
                            <con2:routing-options>
                                <con1:id>_ActionId-8575695815343403766--6bc32b7e.16388b40ebc.-7e51</con1:id>
                                <con2:mode>request</con2:mode>
                                <con2:qualityOfService>best-effort</con2:qualityOfService>
                                <con2:retryCount>0</con2:retryCount>
                            </con2:routing-options>
                            <con2:replace contents-only="true" varName="body">
                                <con1:id>_ActionId-8511316891119908473--69675f1b.1633bbd8e1a.-757a</con1:id>
                                <con2:expr>
                                    <con1:xqueryTransform>
                                        <con1:resource ref="PortalCautivo/Resources/XQuery/IN_XQ_SendSMSSiebel"/>
                                        <con1:param name="nroCelular">
                                            <con1:path>$body/cap:setNextelActiveProduct/phone_number/text()</con1:path>
                                        </con1:param>
                                        <con1:param name="producto">
                                            <con1:path>$body/cap:setNextelActiveProduct/id_pcrf_prod/text()</con1:path>
                                        </con1:param>
                                        <con1:param name="getMensajeSmsProductoOutputCollection1">
                                            <con1:path>$getMensajeSmsProdResp</con1:path>
                                        </con1:param>
                                    </con1:xqueryTransform>
                                </con2:expr>
                            </con2:replace>
                        </con4:outboundTransform>
                    </con4:route>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="response" name="PipelinePrepaidNewBucket_response" errorHandler="_onErrorHandler-7538415494247415963-6ca2b1e9.14e26b1c10e.-7248">
            <con:stage name="stg_out_PrepaidAplicaPromo">
                <con:context/>
                <con:actions>
                    <con1:replace varName="body" contents-only="true" xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                        <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-729e</con5:id>
                        <con1:expr>
                            <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config"><![CDATA[<cap:setNextelActiveProductResponse xmlns:cap="http://captive.portal.ws.ncl.nii.com">
   <transaction_code>{$LC_SQ_TRANSACTION_CODE_BUY}</transaction_code>
   <error_code>0</error_code>
   <err_description>OK</err_description>
</cap:setNextelActiveProductResponse>]]></con5:xqueryText>
                        </con1:expr>
                    </con1:replace>
                    <con4:reply xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con4="http://www.bea.com/wli/sb/stages/config">
                        <con4:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-7128</con4:id>
                    </con4:reply>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="error" name="_onErrorHandler-7538415494247415963-6ca2b1e9.14e26b1c10e.-7249">
            <con:stage name="stg_in_error_prepaid">
                <con:context/>
                <con:actions>
                    <con1:replace varName="body" contents-only="true" xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                        <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-7162</con5:id>
                        <con1:expr>
                            <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config"><![CDATA[<cap:setNextelActiveProductResponse xmlns:cap="http://captive.portal.ws.ncl.nii.com">
   <error_code>{$fault/ctx:errorCode/text()}</error_code>
   <err_description>{concat('Error: ',$fault/ctx:reason/text(),', Nivel: ',$fault/ctx:location/ctx:stage/text())}</err_description>
</cap:setNextelActiveProductResponse>]]></con5:xqueryText>
                        </con1:expr>
                    </con1:replace>
                    <con4:reply xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con4="http://www.bea.com/wli/sb/stages/config">
                        <con4:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-7161</con4:id>
                    </con4:reply>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="error" name="_onErrorHandler-7538415494247415963-6ca2b1e9.14e26b1c10e.-7248">
            <con:stage name="stg_out_error_prepaid">
                <con:context/>
                <con:actions>
                    <con1:replace varName="body" contents-only="true" xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                        <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-70ea</con5:id>
                        <con1:expr>
                            <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config"><![CDATA[<cap:setNextelActiveProductResponse xmlns:cap="http://captive.portal.ws.ncl.nii.com">
   <error_code>{$fault/ctx:errorCode/text()}</error_code>
   <err_description>{concat('Error: ',data($fault/ctx:reason),', Nivel: ',data($fault/ctx:location/ctx:stage))}</err_description>
</cap:setNextelActiveProductResponse>]]></con5:xqueryText>
                        </con1:expr>
                    </con1:replace>
                    <con4:reply xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config" xmlns:con4="http://www.bea.com/wli/sb/stages/config">
                        <con4:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-70e9</con4:id>
                    </con4:reply>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="error" name="_onErrorHandler-7538415494247415963-6ca2b1e9.14e26b1c10e.-5fc8">
            <con:stage name="errorDeposit">
                <con:context>
                    <con1:userNsDecl namespace="http://www.bea.com/wli/sb/stages/transform/config" prefix="con1"/>
                </con:context>
                <con:actions>
                    <con1:replace varName="body" contents-only="true" xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                        <con5:id xmlns:con5="http://www.bea.com/wli/sb/stages/config">_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-5f51</con5:id>
                        <con1:expr>
                            <con5:xqueryText xmlns:con5="http://www.bea.com/wli/sb/stages/config"><![CDATA[<cap:setNextelActiveProductResponse xmlns:cap="http://captive.portal.ws.ncl.nii.com">
   <error_code>1</error_code>
   <err_description>{concat('Error:',data($fault/ctx:details/con1:ReceivedFaultDetail/con1:faultstring),' Nivel: setAsignaBolsasDeposit')}</err_description>
</cap:setNextelActiveProductResponse>]]></con5:xqueryText>
                        </con1:expr>
                    </con1:replace>
                    <con4:reply xmlns:con4="http://www.bea.com/wli/sb/stages/config" xmlns:con3="http://www.bea.com/wli/sb/typesystem/config" xmlns:con2="http://www.bea.com/wli/sb/stages/config" xmlns:con1="http://www.bea.com/wli/sb/stages/transform/config">
                        <con4:id>_ActionId-7538415494247415963-6ca2b1e9.14e26b1c10e.-5f50</con4:id>
                    </con4:reply>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:pipeline type="error" name="_onErrorHandler-566152540498608711--41c73081.15ed54b404f.-77aa">
            <con:stage name="SuscripcionReturn">
                <con:context/>
                <con:actions>
                    <con2:assign varName="statusSuscripcion">
                        <con1:id>_ActionId-566152540498608711--41c73081.15ed54b404f.-76e8</con1:id>
                        <con2:expr>
                            <con1:xqueryText>'00'</con1:xqueryText>
                        </con2:expr>
                    </con2:assign>
                    <con1:resume>
                        <con1:id>_ActionId-566152540498608711--41c73081.15ed54b404f.-76cb</con1:id>
                    </con1:resume>
                </con:actions>
            </con:stage>
        </con:pipeline>
        <con:flow>
            <con:branch-node type="operation" name="BranchNode1">
                <con:context/>
                <con:branch-table>
                    <con:branch name="setNextelActiveProduct">
                        <con:operator>equals</con:operator>
                        <con:value/>
                        <con:flow>
                            <con:pipeline-node name="PipelinePrepaidNewBucket">
                                <con:request>PipelinePrepaidNewBucket_request</con:request>
                                <con:response>PipelinePrepaidNewBucket_response</con:response>
                            </con:pipeline-node>
                        </con:flow>
                    </con:branch>
                    <con:default-branch>
                        <con:flow/>
                    </con:default-branch>
                </con:branch-table>
            </con:branch-node>
        </con:flow>
    </con:router>
</con:pipelineEntry>